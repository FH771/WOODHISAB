<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>BFIDC FINAL ERP</title>
    <style>
        @font-face { font-family: 'Kalpurush'; src: url('https://cdn.jsdelivr.net/gh/at-shovo/bangla-fonts/Kalpurush/Kalpurush.ttf') format('truetype'); }
        body{font-family: 'Segoe UI', Arial, sans-serif; background:#0f172a; margin:0; color:white; -webkit-tap-highlight-color: transparent;}
        header{position:sticky; top:0; background:#020617; padding:10px; display:flex; justify-content:space-between; align-items:center; z-index:999; border-bottom: 1px solid #1e293b;}
        .card{background:white; padding:15px; border-radius:12px; margin:10px; color:black;}
        .grid-inputs{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px}
        input, select { width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box; font-size:16px; }
        .page { background: white; width: 210mm; min-height: 297mm; margin: 10px auto; padding: 10mm; color: black; box-sizing: border-box; display: flex; flex-direction: column; page-break-after: always; }
        .report-header { text-align: center; margin-bottom: 15px; font-family: 'Kalpurush', sans-serif; }
        .report-header h3 { margin: 2px 0; font-size: 19px; font-weight: normal; line-height: 1.4; }
        .dual-container { display: flex; gap: 20px; flex-grow: 1; }
        .col { flex: 1; }
        table { width: 100%; border-collapse: collapse; border: 2px solid #000; }
        th, td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 13px; font-family: 'Kalpurush', sans-serif; }
        th { background: #f3f4f6; }
        .btn-del { background:#ef4444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
        .hidden { display:none!important; }
        @media print { header, .no-print, #loginLayer {display:none!important} body { background: white; } .page { margin: 0; border: none; width: 100%; } }
        /* PDF ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        .pdf-mode .no-print { display: none !important; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div id="loginLayer" style="position:fixed; inset:0; background:#020617; display:flex; align-items:center; justify-content:center; z-index:9999">
    <div style="background:#111827; padding:25px; border-radius:14px; width:90%; max-width:320px; text-align:center">
        <h2 style="color:white; margin-bottom:20px">BFIDC LOGIN</h2>
        <input id="uID" placeholder="User ID" style="margin-bottom:10px">
        <input id="uPass" type="password" placeholder="Password">
        <button onclick="handleLogin()" style="width:100%; margin-top:15px; padding:12px; background:#22c55e; color:white; font-weight:bold; border:none; border-radius:8px; cursor:pointer">LOGIN</button>
    </div>
</div>

<div id="appArea" class="hidden">
    <header>
        <div id="who" style="font-size: 11px; color: #4ade80; font-weight: bold;">ADMIN MODE</div>
        <div style="display:flex; gap:6px">
            <button id="auth_btn" onclick="handleAuthClick()" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:6px; font-size:11px; font-weight:bold; cursor:pointer">üîë DRIVE LOGIN</button>
            <button id="sync_btn" onclick="saveToDrive()" class="hidden" style="background:#34a853; color:white; border:none; padding:8px 12px; border-radius:6px; font-size:11px; font-weight:bold; cursor:pointer">üì§ SAVE</button>
            <button id="load_btn" onclick="loadFromDrive()" class="hidden" style="background:#f59e0b; color:white; border:none; padding:8px 12px; border-radius:6px; font-size:11px; font-weight:bold; cursor:pointer">üì• OPEN</button>
            <button onclick="logout()" style="background:#64748b; color:white; border:none; padding:8px 10px; border-radius:6px; font-size:11px; cursor:pointer">X</button>
        </div>
    </header>
    
    <div id="sync_status" style="font-size: 12px; color: #4ade80; text-align: center; margin: 8px 0; font-weight: bold; height: 16px;"></div>

    <div class="card no-print">
        <div class="grid-inputs">
            <div>‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç<input id="tree" value="1" oninput="updatePiece()" onkeydown="move(event, 'v1')"></div>
            <div>‡¶™‡¶ø‡¶∏ ‡¶®‡¶Ç<input id="piece" readonly style="background:#e2e8f0"></div>
            <div style="grid-column: span 2">‡¶ß‡¶∞‡¶£
                <select id="type" onchange="toggleInputs(); updatePiece();">
                    <option value="log">‡¶ó‡ßã‡¶≤ ‡¶ï‡¶æ‡¶† (Round Log)</option>
                    <option value="wood">‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶æ‡¶† (Sawn Wood)</option>
                </select>
            </div>
            <div><span id="labelV1">‡¶¨‡ßá‡ßú (‡¶á‡¶û‡ßç‡¶ö‡¶ø)</span><input id="v1" inputmode="decimal" onkeydown="move(event, 'v2')"></div>
            <div id="thickBox" class="hidden">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨ (‡¶á‡¶û‡ßç‡¶ö‡¶ø)<input id="ve" inputmode="decimal" onkeydown="move(event, 'v2')"></div>
            <div>‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ (‡¶´‡ßÅ‡¶ü)<input id="v2" inputmode="decimal" onkeydown="move(event, 'save')"></div>
        </div>
        <button onclick="addItem()" id="addBtn" style="width:100%; margin-top:12px; background:#22c55e; color:white; padding:15px; font-size:18px; border:none; border-radius:8px; font-weight:bold; cursor:pointer">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® (ENTER)</button>
        
        <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button onclick="downloadPDF()" style="flex: 1; background:#ef4444; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer">üìÑ SAVE PDF</button>
            <button onclick="window.print()" style="flex: 1; background:#475569; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer">üñ®Ô∏è PRINT</button>
        </div>
    </div>
    <div id="printArea"></div>
</div>

<script>
    const CLIENT_ID = '234418632833-gv6d3hqpnfjeodsi21t2g6afkh81o95i.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyDvmF9t7WvsUvZLs5tFjGVfxTaQxsOKRJs'; 
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    
    let tokenClient, items = JSON.parse(localStorage.getItem("bfidc_data")) || [], currentFileName = "";

    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS}); }); }
    
    function gsiLoaded() { 
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, 
            scope: SCOPES, 
            callback: (resp) => {
                if(resp.access_token) { 
                    document.getElementById('auth_btn').classList.add('hidden'); 
                    document.getElementById('sync_btn').classList.remove('hidden'); 
                    document.getElementById('load_btn').classList.remove('hidden'); 
                    document.getElementById('sync_status').innerText = "‚òÅÔ∏è ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá"; 
                }
            }
        }); 
    }
    
    function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'consent'}); }

    // PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    async function downloadPDF() {
        if (!items.length) { alert("‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á!"); return; }
        const element = document.getElementById('printArea');
        const status = document.getElementById('sync_status');
        
        status.innerText = "‚è≥ PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        element.classList.add('pdf-mode'); 

        const opt = {
            margin: 0,
            filename: (currentFileName ? currentFileName.replace('.json', '') : 'Wood_Report') + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            await html2pdf().set(opt).from(element).save();
            status.innerText = "‚úÖ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤!";
        } catch (e) {
            alert("‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
        } finally {
            element.classList.remove('pdf-mode');
        }
    }

    async function saveToDrive() {
        if (!items.length) { alert("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á!"); return; }
        if (!currentFileName) {
            let n = prompt("‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:", "Wood_Report");
            if (!n) return;
            currentFileName = n + ".json";
        }
        const status = document.getElementById('sync_status');
        status.innerText = "‚è≥ ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        try {
            const fileData = JSON.stringify(items);
            const listRes = await gapi.client.drive.files.list({ q: `name = '${currentFileName}' and trashed = false` });
            if (listRes.result.files && listRes.result.files.length > 0) {
                const fileId = listRes.result.files[0].id;
                await gapi.client.request({ path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: { uploadType: 'media' }, body: fileData });
            } else {
                await gapi.client.drive.files.create({ resource: { name: currentFileName, mimeType: 'application/json' }, media: { mimeType: 'application/json', body: fileData } });
            }
            status.innerText = "‚úÖ " + currentFileName + " ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!";
        } catch(e) { 
            status.innerText = "‚ùå ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠ ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶è‡¶∞‡¶∞! ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®‡•§";
        }
    }

    async function loadFromDrive() {
        let n = prompt("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:", "Wood_Report");
        if(!n) return;
        let fileName = n + ".json";
        try {
            const res = await gapi.client.drive.files.list({ q: `name = '${fileName}' and trashed = false` });
            if(res.result.files.length > 0) {
                const fileId = res.result.files[0].id;
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                items = response.result;
                currentFileName = fileName;
                localStorage.setItem("bfidc_data", JSON.stringify(items));
                render(); alert("‚úÖ " + fileName + " ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } else alert("‚ùå ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        } catch(e) { alert("‚ùå ‡¶≤‡ßã‡¶° ‡¶´‡ßá‡¶á‡¶≤!"); }
    }

    function handleLogin() {
        let id = document.getElementById('uID').value.toLowerCase().trim();
        let pass = document.getElementById('uPass').value.trim();
        if(id === "admin" && pass === "0000") { sessionStorage.setItem("active", "admin"); start(); } 
        else alert("‡¶≠‡ßÅ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
    }
    function start() { document.getElementById('loginLayer').classList.add("hidden"); document.getElementById('appArea').classList.remove("hidden"); updatePiece(); render(); }
    function logout() { sessionStorage.clear(); location.reload(); }
    function toggleInputs() { let isW = document.getElementById('type').value==='wood'; document.getElementById('thickBox').classList.toggle("hidden", !isW); document.getElementById('labelV1').innerText = isW ? "‡¶ö‡¶ì‡ßú‡¶æ" : "‡¶¨‡ßá‡ßú"; render(); }
    function updatePiece() { let count = items.filter(i => i.tree == document.getElementById('tree').value && i.type == document.getElementById('type').value).length; document.getElementById('piece').value = count + 1; }
    
    function move(e, next) { 
        if(e.key === "Enter") { e.preventDefault(); addItem(); } 
        if(e.key === "ArrowRight") { 
            e.preventDefault(); 
            if(e.target.id === 'tree') document.getElementById('v1').focus(); 
            else if(next === 'v2' && document.getElementById('type').value === 'wood' && e.target.id === 'v1') document.getElementById('ve').focus(); 
            else if(next !== 'save') document.getElementById(next).focus(); 
        } 
    }

    function addItem() {
        let t = document.getElementById('tree').value, ty = document.getElementById('type').value, v1v = parseFloat(document.getElementById('v1').value), v2v = parseFloat(document.getElementById('v2').value), vev = parseFloat(document.getElementById('ve').value) || 0;
        if(!v1v || !v2v) return;
        let cft = ty==='log' ? ((v1v/4)**2 * v2v)/144 : (v1v * vev * v2v)/144;
        items.push({tree: t, piece: items.filter(i=>i.tree==t && i.type==ty).length + 1, type: ty, v1: v1v, v2: v2v, ve: vev, cft: +cft.toFixed(2)});
        localStorage.setItem("bfidc_data", JSON.stringify(items));
        document.getElementById('v1').value=""; document.getElementById('v2').value=""; document.getElementById('ve').value=""; render(); updatePiece(); document.getElementById('tree').focus();
    }

    function deleteItem(idx) { if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) { items.splice(idx, 1); localStorage.setItem("bfidc_data", JSON.stringify(items)); render(); updatePiece(); } }

    function render() {
        let ty = document.getElementById('type').value, filtered = items.filter(i => i.type === ty);
        let totalCft = filtered.reduce((s, i) => s + i.cft, 0), totalTrees = new Set(filtered.map(i => i.tree)).size;
        const ITEMS_PER_PAGE = 76; 
        let pagesHtml = "";
        for (let p = 0; p < Math.ceil(filtered.length / ITEMS_PER_PAGE) || p === 0; p++) {
            let pageData = filtered.slice(p * ITEMS_PER_PAGE, (p + 1) * ITEMS_PER_PAGE);
            let mid = Math.ceil(pageData.length / 2);
            let left = pageData.slice(0, mid), right = pageData.slice(mid);
            let tableH = `<tr><th>‡¶ó‡¶æ‡¶õ/‡¶™‡¶ø‡¶∏</th><th>‡¶∏‡¶æ‡¶á‡¶ú</th><th>‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø</th><th class="no-print">‚öô</th></tr>`;
            pagesHtml += `<div class="page">
                <div class="report-header">
                    <h3>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶¨‡¶® ‡¶∂‡¶ø‡¶≤‡ßç‡¶™ ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶® ‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶®, ..................... ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶¨‡¶ø‡¶è‡¶´‡¶Ü‡¶á‡¶°‡¶ø‡¶∏‡¶ø, ‡¶è‡¶≤‡¶™‡¶ø‡¶∏‡¶ø</h3>
                    <h3>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶∞‡ßç‡¶§‡¶®‡¶ï‡ßÉ‡¶§ ‡¶ú‡ßÄ‡¶¨‡¶®‡¶ö‡¶ï‡ßç‡¶∞ ‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡•§</h3>
                </div>
                <div class="dual-container">
                    <div class="col"><table>${tableH}${left.map(i => `<tr><td>${i.tree}/${i.piece}</td><td>${i.type==='log'?i.v1+'"x'+i.v2+"'":i.v1+'"x'+i.ve+'"x'+i.v2+"'"}</td><td>${i.cft}</td><td class="no-print"><button class="btn-del" onclick="deleteItem(${items.indexOf(i)})">D</button></td></tr>`).join('')}</table></div>
                    <div class="col"><table>${tableH}${right.map(i => `<tr><td>${i.tree}/${i.piece}</td><td>${i.type==='log'?i.v1+'"x'+i.v2+"'":i.v1+'"x'+i.ve+'"x'+i.v2+"'"}</td><td>${i.cft}</td><td class="no-print"><button class="btn-del" onclick="deleteItem(${items.indexOf(i)})">D</button></td></tr>`).join('')}</table></div>
                </div>`;
            if (p === Math.ceil(filtered.length / ITEMS_PER_PAGE) - 1 || filtered.length === 0) {
                pagesHtml += `<div class="summary-container"><table><tr><td style="text-align:left">‡¶Æ‡ßã‡¶ü ‡¶ó‡¶æ‡¶õ: ${totalTrees} ‡¶ü‡¶ø, ‡¶Æ‡ßã‡¶ü ‡¶™‡¶ø‡¶∏: ${filtered.length} ‡¶ü‡¶ø, ‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø: ${totalCft.toFixed(2)}</td></tr></table></div>`;
            }
            pagesHtml += `</div>`;
        }
        document.getElementById("printArea").innerHTML = pagesHtml;
    }
    if(sessionStorage.getItem("active")) start();
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gsiLoaded()"></script>
</body>
</html>
