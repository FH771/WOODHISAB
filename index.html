<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC ERP - Ultra Secure Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }

body{font-family:'Segoe UI',Arial;background:#1b5e20;margin:0;transition:.3s}

/* DARK MODE */
body.dark{background:#121212;color:#eee}
body.dark .card{background:#1e1e1e;color:#eee}
body.dark header{background:#000}

#login,#adminPanel,.history-modal{display:flex;justify-content:center;align-items:center;height:100vh;position:fixed;width:100%;top:0;left:0;z-index:2000;background:rgba(27,94,32,.98)}
.box{background:#fff;padding:25px;border-radius:12px;width:340px;box-shadow:0 10px 25px rgba(0,0,0,.3);color:black}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{background:#2e7d32;color:#fff;border:none;font-weight:bold;cursor:pointer}
.logBox{max-height:150px;overflow:auto;background:#fafafa;border:1px solid #ddd;padding:6px;font-size:12px;text-align:left}

#app{display:none;background:#f4f7f6;min-height:100vh}
header{position:sticky;top:0;background:#2e7d32;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center;z-index:999}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:white;padding:15px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:15px;color:black}
.grid-inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}

.page{background:white;width:210mm;min-height:280mm;margin:10px auto;padding:10mm;border:1px solid #ddd;color:black}
.report-header{text-align:center;margin-bottom:20px;font-family:'SutonnyMJ'}
.multi-column-container{column-count:2;column-gap:30px}
table{width:100%;border-collapse:collapse;margin-bottom:5px;break-inside:avoid}
th,td{border:1px solid black;padding:4px;text-align:center;font-size:13px}
.summary{border:2px solid black;padding:10px;margin-top:15px;font-weight:bold;display:flex;justify-content:space-between}
.hidden{display:none!important}

@media print{
header,.no-print,#adminPanel,#login,.history-modal{display:none!important}
body{background:white}
.page{margin:0;border:none;box-shadow:none;width:100%}
}
</style>
</head>
<body>

<div id="login">
  <div class="box">
    <h2 style="text-align:center;color:#2e7d32">Secure Login</h2>
    <input id="id" placeholder="User ID">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="adminPanel" class="hidden">
  <div class="box" style="width:360px">
    <h3>Admin Control</h3>
    <input id="newUser" placeholder="New User ID">
    <input id="newPass" placeholder="New Password">
    <select id="newRole"><option value="operator">Operator</option><option value="admin">Admin</option></select>
    <button onclick="createUser()">Create User</button>
    <hr>
    <input id="deleteUser" placeholder="Delete User ID">
    <button onclick="deleteUserAccount()" style="background:#c62828">Delete User</button>
    <hr>
    <button onclick="downloadBackup()" style="background:#f39c12">Download Backup</button>
    <button onclick="document.getElementById('restoreFile').click()" style="background:#1565c0">Restore Backup</button>
    <input type="file" id="restoreFile" hidden onchange="restoreBackup(event)">
    <hr>
    <h4>Login History</h4>
    <div class="logBox" id="logs"></div>
    <button onclick="closeAdmin()" style="background:#555;margin-top:10px">Close</button>
  </div>
</div>

<div id="app">
<header>
<div id="who"></div>
<div style="font-weight:bold">BFIDC ERP</div>
<div>
<button onclick="toggleDark()" style="background:#333;width:auto;padding:5px 12px">Dark</button>
<button onclick="showHistory()" style="background:#f39c12;width:auto;padding:5px 12px">History</button>
<button onclick="openAdmin()" id="adminBtn" style="background:#1565c0;width:auto;padding:5px 12px">Admin</button>
<button onclick="logout()" style="background:#c62828;width:auto;padding:5px 12px">Logout</button>
</div>
</header>

<div class="container">
<div class="card no-print">
<div class="grid-inputs">
<div><label>Tree No</label><input id="tree" value="1" oninput="resetPieceOnTreeChange()" class="nav-item"></div>
<div><label>Piece</label><input id="piece" value="1" readonly style="background:#f9f9f9"></div>
<div><label>Type</label>
<select id="type" onchange="toggleInputs()">
<option value="log">Round Log</option>
<option value="wood">Sawn Wood</option>
</select>
</div>
<div><label id="l1">Girth (Inch)</label><input id="v1" class="nav-item"></div>
<div id="ve-box" style="display:none;"><label>Thickness (Inch)</label><input id="ve" class="nav-item"></div>
<div><label>Length (Foot)</label><input id="v2" class="nav-item"></div>
</div>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px" class="no-print">
<button onclick="addItem()" id="addBtn" style="grid-column:span 3;background:#2e7d32;padding:15px">Add Data (+)</button>
<button onclick="exportExcel()" style="background:#1d6f42">Download XL</button>
<button onclick="exportDoc()" style="background:#2b579a">Download DOC</button>
<button onclick="window.print()" style="background:#333">Print Report</button>
<button onclick="saveToFile()" style="background:#f39c12">Save Data</button>
<button onclick="clearAll()" style="background:#c62828">Clear All</button>
</div>
</div>
<div id="pagesArea"></div>
</div>
</div>

<div id="historyModal" class="history-modal hidden">
<div class="box" style="width:90%;max-width:450px">
<h3>Saved Files</h3>
<div id="historyList"></div>
<button onclick="closeHistory()" style="background:#666;margin-top:10px">Close</button>
</div>
</div>

<script>
/* SUPER ADMIN */
if(!localStorage.getItem("erpUsers")){
localStorage.setItem("erpUsers",JSON.stringify({
superadmin:{password:"0000",role:"super"},
admin:{password:"1234",role:"admin"}
}))}
if(!localStorage.getItem("erpLogs"))localStorage.setItem("erpLogs","[]")

function logEvent(text){
let logs=JSON.parse(localStorage.getItem("erpLogs"))
logs.unshift(new Date().toLocaleString()+" - "+text)
localStorage.setItem("erpLogs",JSON.stringify(logs.slice(0,50)))
}

function login(){
let id=document.getElementById("id").value.trim(),pass=document.getElementById("pass").value.trim()
let users=JSON.parse(localStorage.getItem("erpUsers"))
if(!users[id])return alert("User not found")
if(users[id].password===pass){
sessionStorage.setItem("erpActive",id); logEvent(id+" logged in"); startApp()
}else alert("Wrong password!")
}

function startApp(){
let id=sessionStorage.getItem("erpActive")
if(!id)return
document.getElementById("login").classList.add("hidden"); document.getElementById("app").style.display="block"
let role=JSON.parse(localStorage.getItem("erpUsers"))[id].role
document.getElementById("who").innerText=`User: ${id.toUpperCase()} (${role})`
if(role!=="admin"&&role!=="super")document.getElementById("adminBtn").style.display="none"
render()
}
function logout(){sessionStorage.clear();location.reload()}

/* DARK MODE */
if(localStorage.getItem("darkMode")==="on")document.body.classList.add("dark")
function toggleDark(){
document.body.classList.toggle("dark")
localStorage.setItem("darkMode",document.body.classList.contains("dark")?"on":"off")
}

/* --- KEY NAVIGATION LOGIC (TYPE DROPDOWN SKIPPED) --- */
document.addEventListener('keydown', function(e) {
    // শুধুমাত্র .nav-item ক্লাস থাকা বক্সগুলোতে নেভিগেট করবে (Type ড্রপডাউন স্কিপ করবে)
    const inputs = Array.from(document.querySelectorAll('.nav-item')).filter(i => {
        const parent = i.closest('div');
        return parent && parent.style.display !== 'none';
    });
    const idx = inputs.indexOf(document.activeElement);

    if (idx > -1) {
        if (e.key === "Enter") {
            e.preventDefault();
            if (document.activeElement.id === "v2") {
                addItem();
                document.getElementById("tree").focus();
                document.getElementById("tree").select();
            } else {
                inputs[idx + 1]?.focus();
                inputs[idx + 1]?.select();
            }
        } 
        else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
            if(document.activeElement.selectionEnd === document.activeElement.value.length || e.key === "ArrowDown"){
                e.preventDefault();
                inputs[idx + 1]?.focus();
                inputs[idx + 1]?.select();
            }
        } 
        else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
            if(document.activeElement.selectionStart === 0 || e.key === "ArrowUp"){
                e.preventDefault();
                inputs[idx - 1]?.focus();
                inputs[idx - 1]?.select();
            }
        }
    }
});

/* USERS & BACKUP */
function createUser(){
let u=newUser.value.trim(),p=newPass.value.trim(),r=newRole.value
let users=JSON.parse(localStorage.getItem("erpUsers"))
if(users[u])return alert("User exists"); users[u]={password:p,role:r};
localStorage.setItem("erpUsers",JSON.stringify(users)); alert("Created")
}
function deleteUserAccount(){
let u=deleteUser.value.trim(); let users=JSON.parse(localStorage.getItem("erpUsers"))
if(u==="superadmin")return alert("Cannot delete Super Admin!"); delete users[u]
localStorage.setItem("erpUsers",JSON.stringify(users)); alert("Deleted")
}
function downloadBackup(){
let data=JSON.stringify(localStorage); let blob=new Blob([data],{type:"application/json"}); saveAs(blob,"BFIDC_Backup.json")
}
function restoreBackup(e){
let reader=new FileReader(); reader.onload=function(){
let data=JSON.parse(reader.result); for(let k in data)localStorage.setItem(k,data[k]); location.reload()
}; reader.readAsText(e.target.files[0])
}

/* MEASUREMENT SYSTEM */
let items=JSON.parse(localStorage.getItem("bfidc_data"))||[]; let editIndex=null
function resetPieceOnTreeChange(){ piece.value=items.filter(i=>i.tree==tree.value).length+1 }
function toggleInputs(){
const isWood=document.getElementById("type").value==="wood"
document.getElementById("ve-box").style.display=isWood?"block":"none"; render()
}

function addItem(){
let tV=document.getElementById("tree").value, typ=document.getElementById("type").value,
    v1V=parseFloat(document.getElementById("v1").value), v2V=parseFloat(document.getElementById("v2").value),
    veV=parseFloat(document.getElementById("ve").value)||0;
if(!tV||!v1V||!v2V)return alert("Fill data!")
let cft=typ==="log"?((v1V/4)**2*v2V)/144:(v1V*veV*v2V)/144
let pNo=editIndex!==null?items[editIndex].piece:(items.filter(i=>i.tree==tV).length+1)
let data={tree:tV,piece:pNo,type:typ,v1:v1V,v2:v2V,ve:veV,cft:+cft.toFixed(2)}
if(editIndex!==null){items[editIndex]=data;editIndex=null}else items.push(data)
localStorage.setItem("bfidc_data",JSON.stringify(items)); render()
document.getElementById("v1").value="";document.getElementById("v2").value="";document.getElementById("ve").value=""
document.getElementById("piece").value=items.filter(i=>i.tree==tV).length+1
}

function render(){
let typF=document.getElementById("type").value; let fil=items.filter(i=>i.type===typF)
let total=0,tSet=new Set()
let hH=typF==='log'?`<div class="report-header"><h2>বিএফআইডিসি, ............................ রাবার বাগান হতে কাপ্তাই</h2><h3>গোল কাঠের মেজারমেন্ট স্লিপ</h3></div>`:`<div style="height:40px"></div>`
let html=`<div class='page' id='printContent'>${hH}<div class="multi-column-container"><table><tr><th>Tree/Pc</th><th>Size</th><th>CFT</th><th class="no-print">⚙</th></tr>`
fil.forEach(i=>{
let sz=i.type=="log"?`${i.v1}"x${i.v2}'`:`${i.v1}"x${i.ve}"x${i.v2}'`
html+=`<tr><td>${i.tree}/${i.piece}</td><td>${sz}</td><td>${i.cft}</td><td class="no-print"><button onclick="startEdit(${items.indexOf(i)})" style="background:#3498db;padding:2px 5px;font-size:10px">Edit</button></td></tr>`
total+=i.cft;tSet.add(i.tree)
})
html+=`</table></div><div class='summary'><span>Total Tree: ${tSet.size}</span><span>Total Piece: ${fil.length}</span><span>Total: ${total.toFixed(2)} CFT</span></div></div>`
document.getElementById("pagesArea").innerHTML=html
}

function startEdit(idx){let i=items[idx];editIndex=idx;document.getElementById("tree").value=i.tree;document.getElementById("piece").value=i.piece;document.getElementById("v1").value=i.v1;document.getElementById("v2").value=i.v2;document.getElementById("ve").value=i.ve;document.getElementById("type").value=i.type;toggleInputs();}
function exportExcel(){let wb=XLSX.utils.book_new();let ws=XLSX.utils.json_to_sheet(items);XLSX.utils.book_append_sheet(wb,ws,"Measurements");XLSX.writeFile(wb,"BFIDC_Data.xlsx")}
function exportDoc(){let content=document.getElementById('printContent').innerHTML;let url='data:application/vnd.ms-word;charset=utf-8,'+encodeURIComponent("<html><body>"+content+"</body></html>");let link=document.createElement("a");link.href=url;link.download='BFIDC_Report.doc';link.click();}
function saveToFile(){let name=prompt("File Name:");if(!name)return;let h=JSON.parse(localStorage.getItem("bfidc_history"))||[];h.push({name,data:[...items]});localStorage.setItem("bfidc_history",JSON.stringify(h));alert("Saved!")}
function showHistory(){let h=JSON.parse(localStorage.getItem("bfidc_history"))||[];document.getElementById("historyList").innerHTML=h.map((x,i)=>`<div style="padding:5px;border-bottom:1px solid #eee">${x.name}<button onclick="loadFromHistory(${i})" style="width:auto;float:right">Load</button></div>`).join('');document.getElementById("historyModal").classList.remove("hidden")}
function loadFromHistory(idx){items=JSON.parse(localStorage.getItem("bfidc_history"))[idx].data;render();closeHistory()}
function clearAll(){if(confirm("Clear?")){items=[];localStorage.removeItem("bfidc_data");render()}}
function openAdmin(){document.getElementById("adminPanel").classList.remove("hidden");loadLogs()}
function closeAdmin(){document.getElementById("adminPanel").classList.add("hidden")}
function closeHistory(){document.getElementById("historyModal").classList.add("hidden")}
function loadLogs(){logs.innerHTML=JSON.parse(localStorage.getItem("erpLogs")).join("<br>")}
if(sessionStorage.getItem("erpActive"))startApp()
</script>
</body>
</html>
