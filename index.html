<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>BFIDC ULTRA ERP - FINAL SAFE</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }
body{font-family:'Segoe UI',Arial,sans-serif;background:#0f172a;margin:0;color:white; -webkit-tap-highlight-color: transparent;}

/* LOGIN SYSTEM */
#loginLayer {position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:9999}
.box{background:#111827;padding:25px;border-radius:14px;width:90%; max-width:320px; text-align:center}
input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none;box-sizing:border-box;background:#1e293b;color:white; font-size: 16px;}
button{background:#22c55e;color:white;font-weight:bold;cursor:pointer;}

/* APP AREA */
#appArea{display:none;background:#f4f7f6;min-height:100vh;color:black}
header{position:sticky;top:0;background:#020617;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center;z-index:999;}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin:10px;color:black}

.grid-inputs{display:grid;grid-template-columns: repeat(2, 1fr); gap:10px}
.full-width { grid-column: span 2; }

.page { background: white; width: 210mm; min-height: 297mm; margin: 10px auto; padding: 10mm; border: 1px solid #ddd; color: black; box-sizing: border-box; overflow: hidden; }
.report-header { text-align: center; margin-bottom: 15px; font-family: 'SutonnyMJ'; color: black; }
.report-header h3 { margin: 2px 0; font-size: 20px; font-weight: normal; }
.multi-column { column-count: 2; column-gap: 30px; column-fill: auto; height: 230mm; }

table { width: 100%; border-collapse: collapse; margin-bottom: 5px; border: 1.5px solid #000; }
th, td { border: 1px solid #000; padding: 4px 2px; text-align: center; font-size: 12px; }
th { background: #f3f4f6; }

.summary{border:2px solid black;padding:10px;margin-top:10px;font-weight:bold;display:flex;justify-content:space-between;font-size:14px}
.hidden{display:none!important}

@media (max-width: 600px) {
    header { flex-direction: column; gap: 8px; text-align: center; }
    .page { width: 98%; margin: 5px auto; padding: 5mm; height: auto; min-height: auto; }
    .multi-column { column-count: 1; height: auto; }
}

@media print {
    header, .no-print, #loginLayer {display:none!important}
    body {background: white}
    .page { margin: 0; border: none; width: 100%; padding: 10mm; }
    @page { size: A4; margin: 0; }
}
</style>
</head>
<body>

<div id="loginLayer">
  <div class="box">
    <h2 style="color:white; margin-bottom: 20px;">BFIDC ERP LOGIN</h2>
    <input id="uID" placeholder="User ID">
    <input id="uPass" type="password" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
  </div>
</div>

<div id="appArea">
<header>
    <div id="who"></div>
    <div style="font-weight:bold; font-size: 16px;">ðŸ”¥ ULTRA BOSS ERP</div>
    <div style="display:flex;gap:5px">
        <button onclick="saveToFile()" style="background:#3b82f6;width:auto;padding:4px 10px; font-size: 12px;">ðŸ’¾ SAVE</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:#f59e0b;width:auto;padding:4px 10px; font-size: 12px;">ðŸ“‚ OPEN</button>
        <input type="file" id="fileInput" class="hidden" accept=".json" onchange="openFile(event)">
        <button onclick="logout()" style="background:#ef4444;width:auto;padding:4px 8px; font-size: 12px;">X</button>
    </div>
</header>

<div class="card no-print">
    <div class="grid-inputs">
        <div>Tree No<input id="tree" value="1" inputmode="numeric" oninput="updatePiece()"></div>
        <div>Piece<input id="piece" readonly tabindex="-1" style="background:#e2e8f0; border: 1px solid #cbd5e1;"></div>
        <div class="full-width">Type
            <select id="type" onchange="toggleInputs()" tabindex="-1">
                <option value="log">Round Log</option>
                <option value="wood">Sawn Wood</option>
            </select>
        </div>
        <div><span id="labelV1">Girth (Inch)</span><input id="v1" inputmode="decimal"></div>
        <div id="thickBox" class="hidden">Thickness<input id="ve" inputmode="decimal"></div>
        <div>Length (Foot)<input id="v2" inputmode="decimal"></div>
    </div>
    
    <button onclick="addItem()" id="addBtn" style="margin-top:15px; background:#22c55e; padding: 15px; font-size: 18px; color: white; border-bottom: 4px solid #16a34a;">SAVE DATA (âœ”)</button>
    
    <div class="grid-inputs" style="margin-top:10px">
        <button onclick="exportExcel()" style="background:#16a34a; font-size: 12px;">Excel</button>
        <button onclick="window.print()" style="background:#475569; font-size: 12px;">Print</button>
        <button onclick="clearAll()" class="full-width" style="background:#dc2626; font-size: 12px; margin-top: 5px;">Clear Current Work</button>
    </div>
</div>

<div id="printArea"></div>
</div>

<script>
let items = JSON.parse(localStorage.getItem("bfidc_data")) || [];
let editIdx = null;

function handleLogin() {
    let id = uID.value.trim().toLowerCase(), ps = uPass.value.trim();
    let users = JSON.parse(localStorage.getItem("bfidc_users")) || {"admin": "0000"};
    if(users[id] && users[id] === ps) { sessionStorage.setItem("active", id); start(); } else alert("Invalid Login!");
}

function start() {
    loginLayer.style.display = "none";
    appArea.style.display = "block";
    let user = sessionStorage.getItem("active");
    who.innerText = "User: " + user.toUpperCase();
    updatePiece(); render();
    document.getElementById("tree").focus();
}

function logout() { sessionStorage.clear(); location.reload(); }

/* NAV LOGIC */
document.addEventListener('keydown', function(e) {
    const active = document.activeElement.id;
    const isWood = document.getElementById("type").value === 'wood';

    if (e.key === "ArrowDown" || e.key === "ArrowRight" || (e.key === "Enter" && active !== "v2")) {
        e.preventDefault();
        if (active === "tree") document.getElementById("v1").focus();
        else if (active === "v1" && isWood) document.getElementById("ve").focus();
        else if (active === "v1" && !isWood) document.getElementById("v2").focus();
        else if (active === "ve") document.getElementById("v2").focus();
        if(document.activeElement.tagName === "INPUT") document.activeElement.select();
    } 
    else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
        e.preventDefault();
        if (active === "v2" && isWood) document.getElementById("ve").focus();
        else if (active === "v2" && !isWood) document.getElementById("v1").focus();
        else if (active === "ve") document.getElementById("v1").focus();
        else if (active === "v1") document.getElementById("tree").focus();
        if(document.activeElement.tagName === "INPUT") document.activeElement.select();
    }

    if (e.key === "Enter" && active === "v2") {
        e.preventDefault();
        addItem();
        document.getElementById("tree").focus();
        document.getElementById("tree").select();
    }
});

function toggleInputs() {
    let isWood = type.value === 'wood';
    thickBox.classList.toggle("hidden", !isWood);
    labelV1.innerText = isWood ? "Width (Inch)" : "Girth (Inch)";
    render();
}

function updatePiece() {
    let tNo = tree.value;
    piece.value = items.filter(i => i.tree == tNo).length + 1;
}

function addItem() {
    let t = tree.value, ty = type.value, v1v = parseFloat(v1.value), v2v = parseFloat(v2.value), vev = parseFloat(ve.value) || 0;
    if(!v1v || !v2v) return;
    let cft = ty === 'log' ? ((v1v/4)**2 * v2v)/144 : (v1v * vev * v2v)/144;
    let pNo = editIdx !== null ? items[editIdx].piece : (items.filter(i => i.tree == t).length + 1);
    let data = {tree: t, piece: pNo, type: ty, v1: v1v, v2: v2v, ve: vev, cft: +cft.toFixed(2)};
    if(editIdx !== null) { items[editIdx] = data; editIdx = null; addBtn.innerText = "SAVE DATA (âœ”)"; }
    else { items.push(data); }
    localStorage.setItem("bfidc_data", JSON.stringify(items));
    v1.value = ""; v2.value = ""; ve.value = "";
    updatePiece(); render();
}

function render() {
    let ty = type.value;
    let filtered = items.filter(i => i.type === ty);
    let total = 0, treeSet = new Set();
    filtered.forEach(i => { total += i.cft; treeSet.add(i.tree); });
    let headerText = ty === 'log' ? `<div class="report-header"><h3>weGdAvBwWwm, .....................&nbsp; ivevi evMvb nâ€¡Z weGdAvBwWwm, Gjwcwm</h3><h3>â€¡cÂ«iâ€¡Yi RbÂ¨ KZÂ©bKâ€¦Z RxebPÂµ nvivâ€¡bv ivevi Kvâ€¡Vi mvBR wjÃ·|</h3></div>` : `<div style="height:10px"></div>`;
    let html = `<div class="page">${headerText}<div class="multi-column"><table><tr><th>Tr/Pc</th><th>Size</th><th>CFT</th><th class="no-print">âš™</th></tr>`;
    filtered.forEach((item) => {
        let size = item.type === 'log' ? `${item.v1}"x${item.v2}'` : `${item.v1}"x${item.ve}"x${item.v2}'`;
        html += `<tr><td>${item.tree}/${item.piece}</td><td>${size}</td><td>${item.cft}</td><td class="no-print"><button onclick="startEdit(${items.indexOf(item)})" style="padding:2px; font-size:10px; background:#3b82f6; width:100%;">Edit</button></td></tr>`;
    });
    html += `</table></div><div class="summary"><span>Trees: ${treeSet.size}</span><span>Pcs: ${filtered.length}</span><span>Total: ${total.toFixed(2)}</span></div></div>`;
    document.getElementById("printArea").innerHTML = html;
}

function startEdit(idx) {
    let i = items[idx]; editIdx = idx;
    tree.value = i.tree; type.value = i.type; v1.value = i.v1; v2.value = i.v2; ve.value = i.ve;
    addBtn.innerText = "UPDATE DATA (âœ”)"; toggleInputs();
    window.scrollTo(0,0);
}

function saveToFile() {
    if(items.length === 0) return alert("No data to save!");
    let fileName = prompt("Enter File Name:", "BFIDC_" + new Date().toLocaleDateString());
    if(!fileName) return;
    let blob = new Blob([JSON.stringify(items)], {type:"application/json"});
    let a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = fileName + ".json"; a.click();
}

function openFile(event) {
    let file = event.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let importedData = JSON.parse(e.target.result);
            if(Array.isArray(importedData)) {
                if(confirm("Replace current work?")) {
                    items = importedData;
                    localStorage.setItem("bfidc_data", JSON.stringify(items));
                    render(); updatePiece();
                }
            }
        } catch (err) { alert("Invalid File!"); }
    };
    reader.readAsText(file);
}

function exportExcel() {
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Data");
    XLSX.writeFile(wb, "Report.xlsx");
}

function clearAll() { if(confirm("Clear current data?")) { items = []; localStorage.removeItem("bfidc_data"); render(); updatePiece(); } }

if(sessionStorage.getItem("active")) start();
</script>
</body>
</html>
