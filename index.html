<script>
    // আপনার ফাইল নাম মনে রাখার জন্য ভেরিয়েবল
    let currentFileName = ""; 

    // ১. দ্রুত সেভ (Local & Memory)
    function addItem() {
        let t = tree.value, ty = type.value, v1v = parseFloat(v1.value), v2v = parseFloat(v2.value), vev = parseFloat(ve.value) || 0;
        if(!v1v || !v2v) return;
        
        let cft = ty==='log' ? ((v1v/4)**2 * v2v)/144 : (v1v * vev * v2v)/144;
        let pc = items.filter(i=>i.tree==t && i.type==ty).length + 1;
        
        // ডাটা পুশ করা
        items.push({tree: t, piece: pc, type: ty, v1: v1v, v2: v2v, ve: vev, cft: +cft.toFixed(2)});
        
        // লোকাল মেমরিতে সেভ (এটি ইনস্ট্যান্ট হয়)
        localStorage.setItem("bfidc_data", JSON.stringify(items));
        
        v1.value=""; v2.value=""; ve.value=""; 
        render(); 
        updatePiece(); 
        tree.focus();
        
        // স্ট্যাটাস আপডেট
        sync_status.innerText = "⚡ ডাটা লোকালি সেভ হয়েছে!";
        setTimeout(() => { if(sync_status.innerText.includes("⚡")) sync_status.innerText = ""; }, 2000);
    }

    // ২. ড্রাইভ সেভ (এক ক্লিকে করার জন্য)
    async function saveToDrive() {
        // যদি আগে নাম না দেওয়া থাকে তবেই নাম চাইবে
        if (!currentFileName) {
            let n = prompt("ফাইলের একটি নাম দিন (একবার দিলেই হবে):", "Wood_Report_1");
            if (!n) return;
            currentFileName = n + ".json";
        }

        sync_status.innerText = "⏳ ড্রাইভে পাঠানো হচ্ছে...";
        
        try {
            const res = await gapi.client.drive.files.list({ q: `name = '${currentFileName}' and trashed = false` });
            const blob = new Blob([JSON.stringify(items)], {type: 'application/json'});
            let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=media';
            let method = (res.result.files.length > 0) ? 'PATCH' : 'POST';

            if(method === 'PATCH') {
                url = `https://www.googleapis.com/upload/drive/v3/files/${res.result.files[0].id}?uploadType=media`;
            } else {
                // নতুন ফাইল তৈরির জন্য মেটাডাটা
                const metadata = { name: currentFileName, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                    body: form
                });
                sync_status.innerText = "✅ ড্রাইভ সেভ সাকসেস!";
                return;
            }

            await fetch(url, { 
                method: method, 
                headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }, 
                body: blob 
            });
            sync_status.innerText = "✅ ড্রাইভ আপডেট হয়েছে!";
        } catch(e) {
            sync_status.innerText = "❌ ড্রাইভ সেভ ফেইল!";
            currentFileName = ""; // এরর হলে নাম রিসেট হবে যেন আবার চাওয়া হয়
        }
    }
</script>
