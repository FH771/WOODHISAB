<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC FINAL ERP</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }
body{font-family:Arial, sans-serif;background:#0f172a;margin:0;color:white}

/* LOGIN LAYER */
#loginLayer {position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#1e293b;padding:30px;border-radius:15px;width:300px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
input, select, button {width:100%;padding:12px;margin-top:10px;border-radius:8px;border:none;box-sizing:border-box}
button {background:#22c55e;color:white;font-weight:bold;cursor:pointer}

/* APP UI */
#appArea {display:none; color: black; background: #f1f5f9; min-height: 100vh;}
header{background:#020617;padding:12px;display:flex;justify-content:space-between;align-items:center;color:white}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:15px}

/* PRINT & TABLE */
.page { background: white; width: 210mm; min-height: 297mm; margin: 10px auto; padding: 10mm; box-sizing: border-box; }
.report-header{text-align:center; font-family:'SutonnyMJ'; margin-bottom:15px; line-height:1.2}
.multi-column { column-count: 2; column-gap: 30px; column-fill: auto; height: 235mm; }
table{width:100%;border-collapse:collapse;border:2px solid black}
th,td{border:1.2px solid black;padding:5px;text-align:center;font-size:14px}
.summary{display:flex;justify-content:space-between;border:2px solid black;padding:10px;margin-top:10px;font-weight:bold}

.hidden{display:none!important}
@media print {
    header, .no-print, #adminTools {display:none!important}
    .page{margin:0;width:100%;border:none}
}
</style>
</head>
<body>

<div id="loginLayer">
    <div class="login-box">
        <h2>BFIDC ERP</h2>
        <input type="text" id="user" placeholder="User ID">
        <input type="password" id="pass" placeholder="Password">
        <button onclick="doLogin()">LOGIN</button>
        <p style="color:#94a3b8;font-size:12px;margin-top:10px">Default: admin | 0000</p>
    </div>
</div>

<div id="appArea">
    <header>
        <div id="userDisplay"></div>
        <div style="font-weight:bold">BFIDC ULTRA ERP</div>
        <div style="display:flex; gap:10px">
            <button id="adminBtn" class="hidden" onclick="showAdmin()" style="background:#f59e0b; width:auto; padding:5px 10px">⚙️ Users</button>
            <button onclick="logout()" style="background:#ef4444; width:auto; padding:5px 10px">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="card no-print">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px">
                <div>Tree No<input id="tree" value="1"></div>
                <div>Type
                    <select id="type" onchange="render()">
                        <option value="log">Round Log</option>
                        <option value="wood">Sawn Wood</option>
                    </select>
                </div>
                <div>Size 1 (Girth/Width)<input id="v1"></div>
                <div id="thickDiv" class="hidden">Thickness<input id="ve"></div>
                <div>Length (Foot)<input id="v2"></div>
            </div>
            <button onclick="addData()" style="margin-top:15px">ADD TO LIST (+)</button>
        </div>

        <div id="adminTools" class="card no-print hidden">
            <h4>User Management</h4>
            <input id="newU" placeholder="New ID">
            <input id="newP" placeholder="New Password">
            <button onclick="makeUser()">Save User</button>
        </div>

        <div class="no-print" style="margin-bottom:10px">
            <button onclick="window.print()" style="background:#475569; width:auto; padding:10px 20px">Print A4 Report</button>
            <button onclick="exportXLS()" style="background:#16a34a; width:auto; padding:10px 20px">Excel Export</button>
            <button onclick="clearData()" style="background:#dc2626; width:auto; padding:10px 20px">Clear All</button>
        </div>

        <div id="printArea"></div>
    </div>
</div>

<script>
/* LOGIN LOGIC */
function doLogin() {
    let u = document.getElementById("user").value.trim().toLowerCase();
    let p = document.getElementById("pass").value.trim();
    
    // Get users from LocalStorage or use default
    let users = JSON.parse(localStorage.getItem("erp_users")) || {"admin": "0000"};
    
    if (users[u] && users[u] === p) {
        sessionStorage.setItem("loggedIn", u);
        startApp();
    } else {
        alert("ভুল ইউজার আইডি অথবা পাসওয়ার্ড!");
    }
}

function startApp() {
    document.getElementById("loginLayer").style.display = "none";
    document.getElementById("appArea").style.display = "block";
    let cur = sessionStorage.getItem("loggedIn");
    document.getElementById("userDisplay").innerText = "User: " + cur.toUpperCase();
    
    if(cur === 'admin') document.getElementById("adminBtn").classList.remove("hidden");
    render();
}

function logout() { sessionStorage.clear(); location.reload(); }

function showAdmin() { document.getElementById("adminTools").classList.toggle("hidden"); }

function makeUser() {
    let id = document.getElementById("newU").value.trim().toLowerCase();
    let ps = document.getElementById("newP").value.trim();
    if(!id || !ps) return alert("সব ঘর পূরণ করুন");
    let users = JSON.parse(localStorage.getItem("erp_users")) || {"admin": "0000"};
    users[id] = ps;
    localStorage.setItem("erp_users", JSON.stringify(users));
    alert("User "+id+" saved!");
}

/* DATA LOGIC */
let items = JSON.parse(localStorage.getItem("erp_data")) || [];

function addData() {
    let tr = document.getElementById("tree").value;
    let ty = document.getElementById("type").value;
    let v1 = parseFloat(document.getElementById("v1").value);
    let v2 = parseFloat(document.getElementById("v2").value);
    let ve = parseFloat(document.getElementById("ve").value) || 0;

    if(!v1 || !v2) return alert("সঠিক মাপ দিন");

    let cft = ty === 'log' ? ((v1/4)**2 * v2)/144 : (v1 * ve * v2)/144;
    let piece = items.filter(i => i.tree == tr).length + 1;

    items.push({tree: tr, piece: piece, type: ty, v1: v1, v2: v2, ve: ve, cft: +cft.toFixed(2)});
    localStorage.setItem("erp_data", JSON.stringify(items));
    render();
    document.getElementById("v1").value = ""; 
    document.getElementById("v2").value = ""; 
    document.getElementById("v1").focus();
}

function render() {
    let ty = document.getElementById("type").value;
    document.getElementById("thickDiv").classList.toggle("hidden", ty === 'log');
    
    let filtered = items.filter(i => i.type === ty);
    let total = 0;
    filtered.forEach(i => total += i.cft);

    let head = ty === 'log' ? `
        <div class="report-header">
            <h3>weGdAvBwWwm, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ivevi evMvb n‡Z weGdAvBwWwm, Gjwcwm, KvßvB</h3>
            <h3>‡c«i‡Yi Rb¨ KZ©bK…Z RxebPµ nviv‡bv ivevi Kv‡Vi mvBR wj÷|</h3>
        </div>` : `<div style="height:30px"></div>`;

    let html = `<div class="page">${head}<div class="multi-column"><table><tr><th>Tree/Pc</th><th>Size</th><th>CFT</th></tr>`;
    filtered.forEach(i => {
        let sz = i.type === 'log' ? `${i.v1}"x${i.v2}'` : `${i.v1}"x${i.ve}"x${i.v2}'`;
        html += `<tr><td>${i.tree}/${i.piece}</td><td>${sz}</td><td>${i.cft}</td></tr>`;
    });
    html += `</table></div><div class="summary"><span>Pieces: ${filtered.length}</span><span>Total: ${total.toFixed(2)} CFT</span></div></div>`;
    document.getElementById("printArea").innerHTML = html;
}

function clearData() { if(confirm("সব ডাটা মুছে যাবে!")) { items = []; localStorage.removeItem("erp_data"); render(); } }

function exportXLS() {
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(items), "Data");
    XLSX.writeFile(wb, "BFIDC_Report.xlsx");
}

// Auto-start if logged in
if(sessionStorage.getItem("loggedIn")) startApp();
</script>
</body>
</html>
