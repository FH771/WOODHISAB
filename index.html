<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC ERP - Professional Version</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
/* SutonnyMJ Support */
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }

@page{size:A4;margin:10mm}
body{font-family: 'SutonnyMJ', Arial, sans-serif; background:#1b5e20; margin:0;}

/* Login & Admin Styles (আপনার দেওয়া হুবহু ডিজাইন) */
#login, #adminPanel, .history-modal {display:flex;justify-content:center;align-items:center;height:100vh; position: fixed; width: 100%; top: 0; left: 0; z-index: 2000; background: rgba(27, 94, 32, 0.98);}
.box{background:#fff;padding:25px;border-radius:12px;width:340px;box-shadow:0 10px 25px rgba(0,0,0,.3); color: black;}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc; box-sizing: border-box;}
button{background:#2e7d32;color:#fff;border:none;font-weight:bold;cursor:pointer}
.logBox{max-height:120px;overflow:auto;background:#fafafa;border:1px solid #ddd;padding:6px;font-size:11px; text-align: left;}

/* App Layout */
#app{display:none; background:#eef2f7; min-height: 100vh;}
header{position:sticky;top:0;background:#2e7d32;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center;z-index:999}
.container{max-width:1200px;margin:auto;padding:10px}
.card{background:white;padding:12px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.1);margin-bottom:10px; color: black;}
.grid-inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}

/* ২ কলাম রিপোর্ট লেআউট */
.page{ background:white; width:210mm; min-height:280mm; margin:10px auto; padding:8mm; border:1px solid #ddd; color: black; }
.multi-column-container { display: flex; gap: 25px; }
.column { flex: 1; }
table{width:100%;border-collapse:collapse; margin-bottom: 10px;}
th,td{border:1px solid black;padding:4px;text-align:center;font-size:15px}
.summary{border:2px solid black;padding:10px;margin-top:10px;font-weight:bold;display:flex;justify-content:space-between}
.hidden{display:none !important}

@media print{
    header, .no-print, #adminPanel, #login, .history-modal{display:none !important} 
    body{background:white} 
    .page{margin:0;border:none;box-shadow:none; width: 100%;}
}
</style>
</head>
<body>

<div id="login">
  <div class="box">
    <h2 style="text-align:center;color:#2e7d32">Secure Login</h2>
    <input id="id" placeholder="User ID">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="adminPanel" class="hidden">
  <div class="box" style="width:380px">
    <h3>User Management</h3>
    <input id="newUser" placeholder="New User ID">
    <input id="newPass" placeholder="New Password">
    <select id="newRole"><option value="operator">Operator</option><option value="admin">Admin</option></select>
    <button onclick="createUser()">Create User</button>
    <hr>
    <h4>Login History</h4>
    <div class="logBox" id="logs"></div>
    <button onclick="closeAdmin()" style="background:#555;margin-top:10px">Close</button>
  </div>
</div>

<div id="historyModal" class="history-modal hidden">
    <div class="box" style="width:90%; max-width:500px">
        <h3>Saved Files (History)</h3>
        <div id="historyList" style="max-height:300px; overflow:auto"></div>
        <button onclick="closeHistory()" style="background:#666; margin-top:10px">Close</button>
    </div>
</div>

<div id="app">
    <header>
        <span id="who"></span>
        <span>BFIDC ERP PRO</span>
        <div>
            <button onclick="showHistory()" style="background:#ff9800; width:auto; padding:5px 10px">History</button>
            <button onclick="openAdmin()" id="adminBtn" style="background:#1565c0; width:auto; padding:5px 10px">Admin</button>
            <button onclick="logout()" style="background:#c62828; width:auto; padding:5px 10px">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="card no-print">
            <div class="grid-inputs">
                <div><label style="font-size:11px">গাছ নং</label><input id="tree" value="1" oninput="resetPieceOnTreeChange()" class="nav-item"></div>
                <div><label style="font-size:11px">পিস</label><input id="piece" value="1" readonly></div>
                <div><label style="font-size:11px">ধরণ</label>
                    <select id="type" onchange="toggleInputs()" class="nav-item">
                        <option value="log">গোল (Log)</option>
                        <option value="wood">সাইজ (Wood)</option>
                    </select>
                </div>
                <div><label id="l1" style="font-size:11px">বেড় (ইঞ্চি)</label><input id="v1" class="nav-item"></div>
                <div id="ve-box" style="display:none;"><label style="font-size:11px">পুরুত্ব (ইঞ্চি)</label><input id="ve" class="nav-item"></div>
                <div><label style="font-size:11px">লম্বা (ফুট)</label><input id="v2" class="nav-item"></div>
            </div>
            
            <div class="grid-inputs" style="margin-top:10px">
                <button onclick="addItem()" id="addBtn" style="background:#2e7d32">Add Data (+)</button>
                <button onclick="saveToFile()" style="background:#ff9800">Save File</button>
                <button onclick="window.print()" style="background:#000">Print Report</button>
                <button onclick="clearAll()" style="background:#c62828">Clear All</button>
            </div>
        </div>

        <div id="pagesArea"></div>
    </div>
</div>

<script>
// --- SECURITY & LOGS (আপনার কোড অনুযায়ী) ---
if(!localStorage.getItem("erpUsers")){
  localStorage.setItem("erpUsers",JSON.stringify({ admin:{password:"1234",role:"admin",fails:0,locked:false} }));
}
if(!localStorage.getItem("erpLogs")){localStorage.setItem("erpLogs","[]");}

function logEvent(text){
  let logs=JSON.parse(localStorage.getItem("erpLogs"));
  logs.unshift(new Date().toLocaleString()+" - "+text);
  localStorage.setItem("erpLogs",JSON.stringify(logs.slice(0,50)));
}

function login(){
  let id=document.getElementById("id").value.trim();
  let pass=document.getElementById("pass").value.trim();
  let users=JSON.parse(localStorage.getItem("erpUsers"));
  if(!users[id]) return alert("User not found");
  if(users[id].password===pass){
    sessionStorage.setItem("erpActive",id); logEvent(id+" logged in"); startApp();
  } else { alert("Wrong password!"); }
}

function startApp(){
  let id=sessionStorage.getItem("erpActive"); if(!id) return;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").style.display="block";
  let role=JSON.parse(localStorage.getItem("erpUsers"))[id].role;
  document.getElementById("who").innerText=`${id.toUpperCase()} (${role})`;
  if(role!=="admin") document.getElementById("adminBtn").style.display="none";
  render();
}
function logout(){ sessionStorage.clear(); location.reload(); }

// --- MEASUREMENT LOGIC ---
let items = JSON.parse(localStorage.getItem("bfidc_data")) || [];
let editIndex = null;

// ARROW NAVIGATION & ENTER KEY LOGIC
document.addEventListener('keydown', (e) => {
    const inputs = Array.from(document.querySelectorAll('.nav-item')).filter(i => i.parentElement.style.display !== 'none');
    const idx = inputs.indexOf(document.activeElement);
    if (idx > -1) {
        if (e.key === "ArrowRight") { e.preventDefault(); inputs[idx + 1]?.focus(); }
        else if (e.key === "ArrowLeft") { e.preventDefault(); inputs[idx - 1]?.focus(); }
        else if (e.key === "Enter") {
            e.preventDefault();
            if (document.activeElement.id === "v2") addItem();
            else inputs[idx + 1]?.focus();
        }
    }
});

function resetPieceOnTreeChange(){
    const tVal = document.getElementById("tree").value;
    document.getElementById("piece").value = items.filter(i=>i.tree == tVal).length + 1;
}

function toggleInputs(){
    const isWood = document.getElementById("type").value === "wood";
    document.getElementById("ve-box").style.display = isWood ? "block" : "none";
    document.getElementById("l1").innerText = isWood ? "চওড়া (ইঞ্চি)" : "বেড় (ইঞ্চি)";
    render();
}

function addItem(){
    let tree=document.getElementById("tree").value, type=document.getElementById("type").value,
        v1=parseFloat(document.getElementById("v1").value), v2=parseFloat(document.getElementById("v2").value),
        ve=parseFloat(document.getElementById("ve").value)||0;
    if(!tree||!v1||!v2) return alert("মাপ দিন!");
    let cft= type==="log"?((v1/4)**2*v2)/144:(v1*ve*v2)/144;
    let piece = editIndex !== null ? items[editIndex].piece : (items.filter(i=>i.tree==tree).length+1);
    let data = {tree, piece, type, v1, v2, ve, cft: +cft.toFixed(2)};
    if(editIndex !== null){ items[editIndex]=data; editIndex=null; } else { items.push(data); }
    localStorage.setItem("bfidc_data", JSON.stringify(items));
    render();
    document.getElementById("v1").value=""; document.getElementById("v2").value=""; document.getElementById("ve").value="";
    document.getElementById("piece").value = items.filter(i=>i.tree == tree).length + 1;
    document.getElementById("tree").focus(); document.getElementById("tree").select();
}

function render(){
    let typeFilter = document.getElementById("type").value;
    let filtered = items.filter(i => i.type === typeFilter);
    let total=0; let treesSet = new Set();
    
    let headerHTML = typeFilter === 'log' ? 
    `<div style="text-align:center"><h2>বিএফআইডিসি, ............................ রাবার বাগান হতে কাপ্তাই</h2><h3>গোল কাঠের মেজারমেন্ট স্লিপ</h3></div>` : `<div style="height:40px"></div>`;

    let half = Math.ceil(filtered.length / 2);
    let leftCol = filtered.slice(0, half);
    let rightCol = filtered.slice(half);

    function createTable(dataList) {
        let tableHtml = `<table><tr><th>গাছ/পিস</th><th>পরিমাপ</th><th>CFT</th><th class="no-print">⚙</th></tr>`;
        dataList.forEach((i) => {
            let size = i.type == "log" ? `${i.v1}"x${i.v2}'` : `${i.v1}"x${i.ve}"x${i.v2}'`;
            tableHtml += `<tr><td>${i.tree}/${i.piece}</td><td>${size}</td><td>${i.cft}</td><td class="no-print">
                <button onclick="startEdit(${items.indexOf(i)})" style="background:#1565c0;padding:2px 5px">E</button>
            </td></tr>`;
            total += i.cft; treesSet.add(i.tree);
        });
        tableHtml += `</table>`;
        return tableHtml;
    }

    let html = `<div class='page'>${headerHTML}
                <div class="multi-column-container">
                    <div class="column">${createTable(leftCol)}</div>
                    <div class="column">${createTable(rightCol)}</div>
                </div>
                <div class='summary'><span>গাছ: ${treesSet.size}</span><span>পিস: ${filtered.length}</span><span>মোট: ${total.toFixed(2)} সিএফটি</span></div>
                </div>`;
    document.getElementById("pagesArea").innerHTML = html;
}

function saveToFile(){
    let name=prompt("ফাইল নাম দিন:"); if(!name) return;
    let history = JSON.parse(localStorage.getItem("bfidc_history")) || [];
    history.push({name, date: new Date().toLocaleString(), data: [...items]});
    localStorage.setItem("bfidc_history", JSON.stringify(history)); alert("Saved!");
}

function showHistory(){
    let history = JSON.parse(localStorage.getItem("bfidc_history")) || [];
    let listHTML = history.map((h, i) => `<div style="border-bottom:1px solid #ddd; padding:8px; display:flex; justify-content:space-between">
        <div>${h.name}</div><button onclick="loadFromHistory(${i})" style="background:green; padding:5px">Load</button></div>`).join('');
    document.getElementById("historyList").innerHTML = listHTML || "No files";
    document.getElementById("historyModal").classList.remove("hidden");
}

function loadFromHistory(idx){
    let history = JSON.parse(localStorage.getItem("bfidc_history"));
    items = history[idx].data; localStorage.setItem("bfidc_data", JSON.stringify(items));
    render(); closeHistory();
}
function startEdit(idx){ let i=items[idx]; editIndex=idx; tree.value=i.tree; piece.value=i.piece; v1.value=i.v1; v2.value=i.v2; ve.value=i.ve; type.value=i.type; toggleInputs(); v1.focus(); }
function clearAll(){ if(confirm("All?")){ items=[]; localStorage.removeItem("bfidc_data"); render(); } }
function openAdmin(){ document.getElementById("adminPanel").classList.remove("hidden"); loadLogs(); }
function closeAdmin(){ document.getElementById("adminPanel").classList.add("hidden"); }
function closeHistory(){ document.getElementById("historyModal").classList.add("hidden"); }
function loadLogs(){ document.getElementById("logs").innerHTML=JSON.parse(localStorage.getItem("erpLogs")).join("<br>")||"No logs"; }

if(sessionStorage.getItem("erpActive")) startApp();
</script>
</body>
</html>
