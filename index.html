<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC ERP - COLUMN FLOW FIX</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }
body{font-family:'Segoe UI',Arial;background:#0f172a;margin:0;transition:.3s;color:white}

/* PANELS */
#login,#adminPanel,.history-modal{display:flex;justify-content:center;align-items:center;height:100vh;position:fixed;width:100%;top:0;left:0;z-index:2000;background:rgba(2,6,23,.98)}
.box{background:#111827;padding:25px;border-radius:14px;width:320px;box-shadow:0 10px 25px rgba(0,0,0,.5);color:white}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none;box-sizing:border-box;background:#1e293b;color:white}
button{background:#22c55e;font-weight:bold;cursor:pointer}

/* APP CONTENT */
#app{display:none;background:#f4f7f6;min-height:100vh;color:black}
header{position:sticky;top:0;background:#020617;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center;z-index:999}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:15px;color:black}
.grid-inputs{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.statGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:15px}
.stat{background:#22c55e;color:white;padding:15px;border-radius:10px;text-align:center;font-weight:bold}

/* A4 PRINT & COLUMN FLOW FIX */
.page {
    background: white;
    width: 210mm; 
    min-height: 297mm;
    margin: 10px auto;
    padding: 15mm; 
    border: 1px solid #ddd;
    color: black;
    box-sizing: border-box;
}
.report-header{text-align:center;margin-bottom:20px;font-family:'SutonnyMJ'; line-height: 1.2;}

/* ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶´‡ßç‡¶≤‡ßã ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ */
.multi-column-container {
    column-count: 2;
    column-gap: 40px;
    column-fill: auto; /* ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßá ‡¶§‡¶¨‡ßá‡¶á ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá */
    height: 220mm; /* A4 ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶∞‡¶ø‡ßü‡¶æ‡¶∞ ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶π‡¶æ‡¶á‡¶ü */
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 5px;
    border: 2px solid #000;
}
th, td {
    border: 1.5px solid #000;
    padding: 6px 4px;
    text-align: center;
    font-size: 15px;
}
th { background: #f3f4f6; }
.btn-edit { background: #3b82f6; color: white; font-size: 11px; padding: 2px 6px; width: auto; }

.summary{border:2px solid black;padding:12px;margin-top:10px;font-weight:bold;display:flex;justify-content:space-between;font-size:16px}
.hidden{display:none!important}

@media print {
    header, .no-print, #adminPanel, #login, .history-modal, #saveStatus, .btn-edit {display:none!important}
    body {background: white}
    .page { margin: 0; border: none; width: 100%; padding: 10mm; }
    @page { size: A4; margin: 0; }
}
</style>
</head>
<body>

<div id="login">
  <div class="box">
    <h2 style="text-align:center">ULTRA LOGIN</h2>
    <input id="idInput" placeholder="User ID">
    <input id="passInput" type="password" placeholder="Password">
    <button onclick="login()">Access System</button>
  </div>
</div>

<div id="app">
<header>
<div id="who"></div>
<div style="font-weight:bold">üî• BFIDC ULTRA HYBRID</div>
<div>
<button onclick="showHistory()" style="background:#f59e0b;width:auto;padding:5px 12px">History</button>
<button onclick="backup()" style="background:#3b82f6;width:auto;padding:5px 12px">Backup</button>
<button onclick="logout()" style="background:#ef4444;width:auto;padding:5px 12px">Logout</button>
</div>
</header>

<div class="container">
<div class="statGrid" id="stats"></div>

<div class="card no-print">
<div class="grid-inputs">
<div><label>Tree No</label><input id="tree" value="1" oninput="resetPiece()" class="nav-item"></div>
<div><label>Piece</label><input id="piece" readonly style="background:#e2e8f0"></div>
<div><label>Type</label>
<select id="type" onchange="toggleInputs()">
<option value="log">Round Log</option>
<option value="wood">Sawn Wood</option>
</select>
</div>
<div><label id="l1">Girth (Inch)</label><input id="v1" class="nav-item"></div>
<div id="ve-box" style="display:none;"><label>Thickness (Inch)</label><input id="ve" class="nav-item"></div>
<div><label>Length (Foot)</label><input id="v2" class="nav-item"></div>
</div>

<button onclick="addItem()" id="addBtn" style="margin-top:15px;padding:15px">ADD DATA (+)</button>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
<button onclick="exportExcel()" style="background:#16a34a">Excel</button>
<button onclick="window.print()" style="background:#475569">Print A4</button>
<button onclick="setFileName()" style="background:#f59e0b">Set Name</button>
<button onclick="clearAll()" style="background:#dc2626">Clear</button>
</div>
<p id="saveStatus" style="font-size:12px; color:#16a34a; text-align:right; margin-top:5px; font-weight:bold;"></p>
</div>

<input id="search" placeholder="Search tree no..." oninput="render()" class="card no-print" style="width:calc(100% - 30px)">

<div id="pagesArea"></div>
</div>
</div>

<div id="historyModal" class="history-modal hidden">
<div class="box" style="width:90%;max-width:400px">
<h3>Saved Files</h3>
<div id="historyList" style="max-height:300px;overflow:auto"></div>
<button onclick="closeHistory()" style="background:#475569;margin-top:10px">Close</button>
</div>
</div>

<script>
/* SECURITY & SESSION */
async function hash(t){ const e=new TextEncoder().encode(t); const b=await crypto.subtle.digest('SHA-256',e); return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''); }
(async()=>{ if(!localStorage.getItem("users")){ localStorage.setItem("users",JSON.stringify({ superadmin:{password:await hash("0000"),role:"super"}, admin:{password:await hash("1234"),role:"admin"} })); } })();
async function login(){ let id=idInput.value.trim(), p=await hash(passInput.value.trim()); let users=JSON.parse(localStorage.getItem("users")); if(users[id] && users[id].password===p){ sessionStorage.setItem("active",id); start(); } else alert("Access Denied"); }
function logout(){sessionStorage.clear();location.reload()}
function start(){ document.getElementById("login").classList.add("hidden"); document.getElementById("app").style.display="block"; who.innerText="User: "+sessionStorage.getItem("active").toUpperCase(); render(); }

/* ARROW NAVIGATION */
document.addEventListener('keydown', function(e) {
    const inputs = Array.from(document.querySelectorAll('.nav-item')).filter(i => i.closest('div').style.display !== 'none');
    const idx = inputs.indexOf(document.activeElement);
    if (idx > -1) {
        if (e.key === "Enter") {
            e.preventDefault();
            if (document.activeElement.id === "v2") { addItem(); document.getElementById("tree").focus(); document.getElementById("tree").select(); }
            else { inputs[idx + 1]?.focus(); inputs[idx + 1]?.select(); }
        } else if (["ArrowRight", "ArrowDown"].includes(e.key)) {
            if(document.activeElement.selectionEnd === document.activeElement.value.length || e.key === "ArrowDown"){ e.preventDefault(); inputs[idx + 1]?.focus(); inputs[idx + 1]?.select(); }
        } else if (["ArrowLeft", "ArrowUp"].includes(e.key)) {
            if(document.activeElement.selectionStart === 0 || e.key === "ArrowUp"){ e.preventDefault(); inputs[idx - 1]?.focus(); inputs[idx - 1]?.select(); }
        }
    }
});

/* CORE LOGIC */
let items=JSON.parse(localStorage.getItem("bfidc_ultra"))||[];
let editIndex=null;
let currentFileName = localStorage.getItem("bfidc_current_file") || "AutoSave_Default";

function resetPiece(){ piece.value=items.filter(i=>i.tree==tree.value).length+1 }
function toggleInputs(){ const isWood=document.getElementById("type").value==="wood"; document.getElementById("ve-box").style.display=isWood?"block":"none"; document.getElementById("l1").innerText=isWood?"Width (Inch)":"Girth (Inch)"; render(); }
function setFileName(){ let n = prompt("File Name:", currentFileName); if(n){ currentFileName = n; localStorage.setItem("bfidc_current_file", n); autoSave(); } }
function autoSave(){
    let history = JSON.parse(localStorage.getItem("bfidc_history")) || [];
    let idx = history.findIndex(h => h.name.toLowerCase() === currentFileName.toLowerCase());
    if(idx !== -1) history[idx].data = [...items];
    else history.push({name: currentFileName, data: [...items]});
    localStorage.setItem("bfidc_history", JSON.stringify(history));
    localStorage.setItem("bfidc_ultra", JSON.stringify(items));
    document.getElementById("saveStatus").innerText = "‚úî Auto-Saved: " + currentFileName;
}

function addItem(){
    let tV=tree.value, typ=type.value, v1V=parseFloat(v1.value), v2V=parseFloat(v2.value), veV=parseFloat(ve.value)||0;
    if(!v1V || !v2V)return alert("Missing Data!");
    let cft=typ==="log"?((v1V/4)**2*v2V)/144:(v1V*veV*v2V)/144;
    let pNo = editIndex !== null ? items[editIndex].piece : (items.filter(i=>i.tree==tV).length+1);
    let data = {tree:tV, piece:pNo, type:typ, v1:v1V, v2:v2V, ve:veV, cft:+cft.toFixed(2)};
    if(editIndex !== null){ items[editIndex] = data; editIndex = null; document.getElementById("addBtn").innerText = "ADD DATA (+)"; }
    else { items.push(data); }
    render(); autoSave();
    v1.value="";v2.value="";ve.value=""; resetPiece();
}

function startEdit(idx){
    let i = items[idx]; editIndex = idx;
    tree.value = i.tree; piece.value = i.piece; v1.value = i.v1; v2.value = i.v2; ve.value = i.ve; type.value = i.type;
    document.getElementById("addBtn").innerText = "UPDATE DATA (‚úî)";
    toggleInputs(); window.scrollTo(0,0);
}

function render(){
    let s=search.value?.toLowerCase()||"";
    let typF=type.value;
    let filtered=items.filter(i=>i.type===typF && i.tree.toString().includes(s));
    let total=0, tSet=new Set();
    filtered.forEach(i=>{total+=i.cft; tSet.add(i.tree)});
    stats.innerHTML=`<div class="stat">Trees: ${tSet.size}</div><div class="stat">Pieces: ${filtered.length}</div><div class="stat">Total: ${total.toFixed(2)} CFT</div>`;
    
    let headerText = "";
    if(typF === 'log') {
        headerText = `<div class="report-header">
            <h3>weGdAvBwWwm, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ivevi evMvb n‚Ä°Z weGdAvBwWwm, Gjwcwm, Kv√üvB</h3>
            <h3>‚Ä°c¬´i‚Ä°Yi Rb¬® KZ¬©bK‚Ä¶Z RxebP¬µ nviv‚Ä°bv ivevi Kv‚Ä°Vi mvBR wj√∑|</h3>
        </div>`;
    } else { headerText = `<div style="height:20px"></div>`; }

    let html=`<div class='page' id='printContent'>${headerText}<div class="multi-column-container"><table><tr><th>Tree/Pc</th><th>Size</th><th>CFT</th><th class="no-print">‚öô</th></tr>`;
    filtered.forEach(i=>{
        let actualIdx = items.indexOf(i);
        let sz=i.type=="log"?`${i.v1}"x${i.v2}'`:`${i.v1}"x${i.ve}"x${i.v2}'`;
        html+=`<tr><td>${i.tree}/${i.piece}</td><td>${sz}</td><td>${i.cft}</td><td class="no-print"><button class="btn-edit" onclick="startEdit(${actualIdx})">Edit</button></td></tr>`;
    });
    html+=`</table></div><div class='summary'><span>Trees: ${tSet.size}</span><span>Pieces: ${filtered.length}</span><span>Total: ${total.toFixed(2)} CFT</span></div></div>`;
    document.getElementById("pagesArea").innerHTML=html;
}

/* BACKUP & HISTORY */
function exportExcel(){let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(items),"Data"); XLSX.writeFile(wb,currentFileName+".xlsx")}
function backup(){let b=new Blob([JSON.stringify(localStorage)],{type:"application/json"}); let a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="ULTRA_BACKUP.json"; a.click();}
function showHistory(){let h=JSON.parse(localStorage.getItem("bfidc_history"))||[]; historyList.innerHTML=h.map((x,i)=>`<div style="padding:10px;border-bottom:1px solid #334155;color:white"><b>${x.name}</b><button onclick="loadFromHistory(${i})" style="width:auto;float:right">Load</button></div>`).join(''); historyModal.classList.remove("hidden")}
function loadFromHistory(idx){ let h=JSON.parse(localStorage.getItem("bfidc_history"))[idx]; items=h.data; currentFileName=h.name; localStorage.setItem("bfidc_ultra",JSON.stringify(items)); localStorage.setItem("bfidc_current_file",h.name); render(); closeHistory(); }
function clearAll(){if(confirm("Delete All Data?")){items=[]; localStorage.removeItem("bfidc_ultra"); render();}}
function closeHistory(){historyModal.classList.add("hidden")}

if(sessionStorage.getItem("active"))start();
resetPiece();
</script>
</body>
</html>
