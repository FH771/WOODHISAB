<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC ERP ULTRA PRO - Secure</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
@page{size:A4;margin:10mm}
body{font-family:Segoe UI, Arial;margin:0;background:#1b5e20; transition: 0.3s;}
.dark-mode{background:#121212 !important; color:white}

/* Login Styles */
#loginSection, #adminPanel{display:flex;justify-content:center;align-items:center;height:100vh; position: fixed; width: 100%; top: 0; left: 0; z-index: 2000; background: #1b5e20;}
.box{background:#fff;padding:25px;border-radius:12px;width:340px;box-shadow:0 10px 25px rgba(0,0,0,.3); color: black;}

/* App Styles */
#app{display:none; background:#eef2f7; min-height: 100vh;}
header{position:sticky;top:0;background:#2e7d32;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center;z-index:999}
.container{max-width:1200px;margin:auto;padding:10px}
.card{background:white;padding:12px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.1);margin-bottom:10px; color: black;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
input,select,button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px; box-sizing: border-box;}
button{background:#2e7d32;color:white;border:none;cursor:pointer;font-weight:bold}
.page{background:white;width:210mm;min-height:297mm;margin:10px auto;padding:10mm;border:1px solid #ddd; color: black;}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid black;padding:6px;text-align:center;font-size:13px}
.summary{border:2px solid black;padding:10px;margin-top:10px;font-weight:bold;display:flex;justify-content:space-between}
.hidden{display:none !important}

@media print{header, .no-print, #adminPanel, #loginSection{display:none !important} body{background:white} .page{margin:0;border:none;box-shadow:none}}
</style>
</head>
<body>

<div id="loginSection">
  <div class="box">
    <h2 style="text-align:center;color:#2e7d32">BFIDC Secure Login</h2>
    <input id="loginId" placeholder="User ID">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="handleLogin()" style="margin-top:15px">Enter System</button>
  </div>
</div>

<div id="adminPanel" class="hidden">
  <div class="box">
    <h3 style="margin-top:0">User Management</h3>
    <label style="font-size:11px">Create New User</label>
    <input id="newUser" placeholder="New ID">
    <input id="newPass" placeholder="Password">
    <select id="newRole">
      <option value="operator">Operator</option>
      <option value="manager">Manager</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="createUser()" style="margin-top:10px;background:#1565c0">Create User</button>
    <hr>
    <button onclick="closeAdmin()" style="background:#555">Close Panel</button>
  </div>
</div>

<div id="app">
    <header>
        <span id="displayUser"></span>
        <span>BFIDC ULTRA PRO üå≤</span>
        <div>
            <button onclick="openAdmin()" id="adminBtn" class="no-print" style="background:#1565c0; font-size:12px">Admin</button>
            <button onclick="toggleDark()" class="no-print" style="background:none;font-size:18px">üåô</button>
            <button onclick="logout()" class="no-print" style="background:#c62828; font-size:12px">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="card grid no-print">
            <div><label style="font-size:11px">‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç</label><input id="tree" value="1" oninput="resetPieceOnTreeChange()" class="nav-item"></div>
            <div><label style="font-size:11px">‡¶™‡¶ø‡¶∏</label><input id="piece" value="1" readonly></div>
            <div><label style="font-size:11px">‡¶ß‡¶∞‡¶£</label>
                <select id="type" onchange="toggleInputs()" class="nav-item">
                    <option value="log">‡¶ó‡ßã‡¶≤ (Log)</option>
                    <option value="wood">‡¶∏‡¶æ‡¶á‡¶ú (Wood)</option>
                </select>
            </div>
            <div><label id="l1" style="font-size:11px">‡¶¨‡ßá‡¶°‡¶º (‡¶á‡¶û‡ßç‡¶ö‡¶ø)</label><input id="v1" placeholder="‡¶¨‡ßá‡¶°‡¶º" class="nav-item"></div>
            <div id="ve-box" style="display:none;"><label style="font-size:11px">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨ (‡¶á‡¶û‡ßç‡¶ö‡¶ø)</label><input id="ve" placeholder="‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨" class="nav-item"></div>
            <div><label style="font-size:11px">‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ (‡¶´‡ßÅ‡¶ü)</label><input id="v2" placeholder="‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ" class="nav-item"></div>
        </div>

        <div class="card grid no-print">
            <button onclick="addItem()" id="addBtn" style="background:#2e7d32">Add Data (+)</button>
            <button onclick="exportExcel()" style="background:#1f6e43">Export Excel</button>
            <button onclick="window.print()" style="background:#000">Print Report</button>
            <button onclick="clearAll()" style="background:#c62828">Clear All</button>
            <input id="search" placeholder="üîé Search..." oninput="render()">
        </div>

        <div id="pagesArea"></div>
    </div>
</div>

<script>
// --- AUTH SYSTEM ---
if(!localStorage.getItem("erpUsers")){
  localStorage.setItem("erpUsers",JSON.stringify({
    admin:{password:"1234",role:"admin"},
    operator:{password:"1234",role:"operator"}
  }));
}

function getUsers(){ return JSON.parse(localStorage.getItem("erpUsers")); }

function handleLogin(){
  let id=document.getElementById("loginId").value.trim().toLowerCase();
  let pass=document.getElementById("loginPass").value.trim();
  let users=getUsers();

  if(users[id] && users[id].password===pass){
    sessionStorage.setItem("erpActive",id);
    startApp();
  } else alert("‡¶≠‡ßÅ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
}

function startApp(){
  let id=sessionStorage.getItem("erpActive");
  if(!id) return;

  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("app").style.display="block";
  
  let userObj = getUsers()[id];
  document.getElementById("displayUser").innerText = `${id.toUpperCase()} (${userObj.role})`;
  
  if(userObj.role !== "admin") document.getElementById("adminBtn").style.display="none";
  render();
}

function logout(){ sessionStorage.clear(); location.reload(); }
function openAdmin(){ document.getElementById("adminPanel").classList.remove("hidden"); }
function closeAdmin(){ document.getElementById("adminPanel").classList.add("hidden"); }

function createUser(){
  let u=document.getElementById("newUser").value.trim().toLowerCase();
  let p=document.getElementById("newPass").value.trim();
  let r=document.getElementById("newRole").value;
  if(!u || !p) return alert("‡¶∏‡¶¨ ‡¶ò‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®");
  let users=getUsers();
  if(users[u]) return alert("‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ü‡¶õ‡ßá!");
  users[u]={password:p, role:r};
  localStorage.setItem("erpUsers",JSON.stringify(users));
  alert("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
}

// --- MEASUREMENT SYSTEM ---
let items = JSON.parse(localStorage.getItem("bfidc_data")) || [];
let editIndex = null;

// ARROW NAVIGATION & ENTER LOGIC
document.addEventListener('keydown', (e) => {
    const inputs = Array.from(document.querySelectorAll('.nav-item')).filter(i => i.parentElement.style.display !== 'none');
    const idx = inputs.indexOf(document.activeElement);
    if (idx > -1) {
        if (e.key === "ArrowRight") { e.preventDefault(); inputs[idx + 1]?.focus(); }
        else if (e.key === "ArrowLeft") { e.preventDefault(); inputs[idx - 1]?.focus(); }
        else if (e.key === "Enter") {
            e.preventDefault();
            if (document.activeElement.id === "v2") addItem();
            else inputs[idx + 1]?.focus();
        }
    }
});

function resetPieceOnTreeChange(){
    const tVal = document.getElementById("tree").value;
    document.getElementById("piece").value = items.filter(i=>i.tree == tVal).length + 1;
}

function toggleInputs(){
    const isWood = document.getElementById("type").value === "wood";
    document.getElementById("ve-box").style.display = isWood ? "block" : "none";
    document.getElementById("l1").innerText = isWood ? "‡¶ö‡¶ì‡¶°‡¶º‡¶æ (Width)" : "‡¶¨‡ßá‡¶°‡¶º (Round)";
    render();
}

function addItem(){
    let tree = document.getElementById("tree").value;
    let type = document.getElementById("type").value;
    let v1 = parseFloat(document.getElementById("v1").value);
    let v2 = parseFloat(document.getElementById("v2").value);
    let ve = parseFloat(document.getElementById("ve").value) || 0;

    if(!tree || !v1 || !v2) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®!");

    let cft = type === "log" ? ((v1/4)**2 * v2) / 144 : (v1 * ve * v2) / 144;
    let piece = editIndex !== null ? items[editIndex].piece : (items.filter(i=>i.tree == tree).length + 1);

    let data = {tree, piece, type, v1, v2, ve, cft: +cft.toFixed(2)};

    if(editIndex !== null){
        items[editIndex] = data; editIndex = null;
        document.getElementById("addBtn").innerText = "Add Data (+)";
    } else {
        items.push(data);
    }

    localStorage.setItem("bfidc_data", JSON.stringify(items));
    render();

    // Reset fields and Focus back to Tree No
    document.getElementById("v1").value="";
    document.getElementById("v2").value="";
    document.getElementById("ve").value="";
    document.getElementById("piece").value = items.filter(i=>i.tree == tree).length + 1;
    document.getElementById("tree").focus();
    document.getElementById("tree").select();
}

function render(){
    let s = document.getElementById("search").value.toLowerCase();
    let typeFilter = document.getElementById("type").value;
    let filtered = items.filter(i => i.type === typeFilter && JSON.stringify(i).toLowerCase().includes(s));

    let total=0; let trees = new Set();
    
    // Header Logic
    let headerHTML = typeFilter === 'log' 
        ? `<div style="text-align:center"><h2>‡¶¨‡¶ø‡¶è‡¶´‡¶Ü‡¶á‡¶°‡¶ø‡¶∏‡¶ø, ............................ ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶ï‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶á</h2><h3>‡¶ó‡ßã‡¶≤ ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶Æ‡ßá‡¶ú‡¶æ‡¶∞‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶≤‡¶ø‡¶™</h3></div>` 
        : `<div style="height:50px"></div>`;

    let html = `<div class='page'>${headerHTML}<table>
                <tr><th>‡¶ï‡ßç‡¶∞.‡¶®‡¶Ç (‡¶ó‡¶æ‡¶õ/‡¶™‡¶ø‡¶∏)</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™ (‡¶∏‡¶æ‡¶á‡¶ú)</th><th>‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø (CFT)</th><th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>`;

    filtered.forEach((i, idx) => {
        let size = i.type == "log" ? `${i.v1}" x ${i.v2}'` : `${i.v1}" x ${i.ve}" x ${i.v2}'`;
        html += `<tr>
            <td>${i.tree}/${i.piece}</td>
            <td>${size}</td>
            <td>${i.cft}</td>
            <td class="no-print">
                <button onclick="startEdit(${items.indexOf(i)})" style="background:#1565c0;padding:2px 8px">Edit</button>
                <button onclick="del(${items.indexOf(i)})" style="background:#c62828;padding:2px 8px">X</button>
            </td>
        </tr>`;
        total += i.cft; trees.add(i.tree);
    });

    html += `</table><div class='summary'><span>‡¶Æ‡ßã‡¶ü ‡¶ó‡¶æ‡¶õ: ${trees.size}</span><span>‡¶Æ‡ßã‡¶ü ‡¶™‡¶ø‡¶∏: ${filtered.length}</span><span>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø: ${total.toFixed(2)}</span></div></div>`;
    document.getElementById("pagesArea").innerHTML = html;
}

function startEdit(idx){
    let i = items[idx]; editIndex = idx;
    document.getElementById("tree").value = i.tree;
    document.getElementById("piece").value = i.piece;
    document.getElementById("v1").value = i.v1;
    document.getElementById("v2").value = i.v2;
    document.getElementById("ve").value = i.ve;
    document.getElementById("type").value = i.type;
    toggleInputs();
    document.getElementById("addBtn").innerText = "Update Data (‚úî)";
    document.getElementById("v1").focus();
}

function del(idx){ if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")){ items.splice(idx,1); localStorage.setItem("bfidc_data", JSON.stringify(items)); render(); } }
function clearAll(){ if(confirm("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")){ items=[]; localStorage.removeItem("bfidc_data"); render(); } }
function toggleDark(){ document.body.classList.toggle("dark-mode"); }

function exportExcel(){
    let ws = XLSX.utils.json_to_sheet(items);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "WoodData");
    XLSX.writeFile(wb, "BFIDC_Report.xlsx");
}

// Auto-login check
if(sessionStorage.getItem("erpActive")) startApp();
</script>
</body>
</html>
