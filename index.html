<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BFIDC Wood Manager PRO - Updated</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: Segoe UI, Arial; margin: 0; background: #eef2f7; transition: 0.3s; }
        header { position: sticky; top: 0; background: #1b5e20; color: white; padding: 12px; font-size: 20px; text-align: center; z-index: 999; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1100px; margin: auto; padding: 10px; }
        .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,.1); margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
        input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        button { background: #2e7d32; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: .9; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background: #f4f4f4; }
        .summary { font-weight: bold; padding: 15px; background: #e8f5e9; border-radius: 8px; display: flex; justify-content: space-between; margin-top: 10px; border: 1px solid #2e7d32; }
        .dark { background: #121212; color: white; }
        .dark .card { background: #1e1e1e; color: white; }
        .dark input, .dark select { background: #2c2c2c; color: white; border: 1px solid #444; }
        .dark th { background: #333; color: white; }
        .edit-btn { background: #1565c0; margin-right: 5px; padding: 5px 10px; }
        .del-btn { background: #c62828; padding: 5px 10px; }

        /* Print Style - As per your requirement */
        @media print {
            .card, header, .no-print { display: none !important; }
            body { background: white; }
            .print-area { display: block !important; }
            table { border: 1px solid black; }
            th, td { border: 1px solid black; }
        }
    </style>
</head>
<body>

<header>
    <div style="width: 40px;"></div>
    <span>BFIDC Wood Manager PRO üå≤</span>
    <button onclick="toggleDark()" style="background:none; font-size:20px;">üåô</button>
</header>

<div class="container">
    <div class="card grid no-print">
        <div><label style="font-size:11px">Tree No</label><input id="tree" value="1" class="nav-item"></div>
        <div><label style="font-size:11px">Piece</label><input id="piece" value="1" readonly></div>
        <div><label style="font-size:11px">Type</label>
            <select id="type" onchange="toggleType()" class="nav-item">
                <option value="log">Log (‡¶ó‡ßã‡¶≤)</option>
                <option value="wood">Wood (‡¶∏‡¶æ‡¶á‡¶ú)</option>
            </select>
        </div>
        <div><label id="l1" style="font-size:11px">Round (‡¶¨‡ßá‡ßú)</label><input id="v1" placeholder="Inches" class="nav-item"></div>
        <div id="ve-box" style="display:none;"><label style="font-size:11px">Thickness</label><input id="ve" placeholder="Inches" class="nav-item"></div>
        <div><label style="font-size:11px">Length (‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ)</label><input id="v2" placeholder="Feet" class="nav-item"></div>
        <button onclick="addItem()" id="addBtn" style="height: 40px; margin-top: 18px;">Add Item (+)</button>
    </div>

    <div class="card grid no-print">
        <input id="search" placeholder="üîé Search history..." oninput="render()">
        <button onclick="exportExcel()" style="background:#1f6e43">Excel</button>
        <button onclick="exportDoc()" style="background:#2b579a">Word (Doc)</button>
        <button onclick="window.print()" style="background:#000">Print Report</button>
        <button onclick="clearAll()" style="background:#c62828">Clear All</button>
    </div>

    <div class="card" id="print-content">
        <div id="report-header" style="text-align:center; margin-bottom:10px;"></div>
        <table>
            <thead>
                <tr>
                    <th>Tree/Piece</th>
                    <th>Type</th>
                    <th>Size (Measurement)</th>
                    <th>CFT</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        <div class="summary" id="summary"></div>
    </div>
</div>

<script>
    let items = JSON.parse(localStorage.getItem("wood_pro")) || [];
    let editIndex = null;

    // --- Navigation & Enter Logic ---
    document.addEventListener('keydown', (e) => {
        const inputs = Array.from(document.querySelectorAll('.nav-item')).filter(i => i.parentElement.style.display !== 'none');
        const idx = inputs.indexOf(document.activeElement);
        if (idx > -1) {
            if (e.key === "ArrowRight") { e.preventDefault(); inputs[idx + 1]?.focus(); }
            else if (e.key === "ArrowLeft") { e.preventDefault(); inputs[idx - 1]?.focus(); }
            else if (e.key === "Enter") {
                e.preventDefault();
                if (document.activeElement.id === "v2") addItem();
                else inputs[idx + 1]?.focus();
            }
        }
    });

    function toggleType() {
        const type = document.getElementById("type").value;
        const isWood = type === "wood";
        document.getElementById("ve-box").style.display = isWood ? "block" : "none";
        document.getElementById("l1").innerText = isWood ? "Width (‡¶ö‡¶ì‡ßú‡¶æ)" : "Round (‡¶¨‡ßá‡ßú)";
        render();
    }

    function addItem() {
        let tree = document.getElementById("tree").value;
        let type = document.getElementById("type").value;
        let v1 = parseFloat(document.getElementById("v1").value) || 0;
        let v2 = parseFloat(document.getElementById("v2").value) || 0;
        let ve = parseFloat(document.getElementById("ve").value) || 0;

        if (!tree || !v1 || !v2) return alert("‡¶Æ‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®!");

        let cft = type === "log" ? ((v1 / 4) ** 2 * v2) / 144 : (v1 * ve * v2) / 144;
        let piece = editIndex !== null ? items[editIndex].piece : (items.filter(i => i.tree == tree).length + 1);

        let data = { tree, piece, type, v1, v2, ve, cft: +cft.toFixed(2) };

        if (editIndex !== null) {
            items[editIndex] = data;
            editIndex = null;
            document.getElementById("addBtn").innerText = "Add Item (+)";
            document.getElementById("addBtn").style.background = "#2e7d32";
        } else {
            items.push(data);
            document.getElementById("piece").value = items.filter(i => i.tree == tree).length + 1;
        }

        localStorage.setItem("wood_pro", JSON.stringify(items));
        render();

        // Reset fields and focus to Tree No
        document.getElementById("v1").value = "";
        document.getElementById("v2").value = "";
        document.getElementById("ve").value = "";
        document.getElementById("tree").focus();
        document.getElementById("tree").select();
    }

    function render() {
        let search = document.getElementById("search").value.toLowerCase();
        let typeFilter = document.getElementById("type").value;
        let tbody = document.getElementById("tbody");
        let header = document.getElementById("report-header");
        
        // Header Logic
        if(typeFilter === 'log') {
            header.innerHTML = `<h3>‡¶¨‡¶ø‡¶è‡¶´‡¶Ü‡¶á‡¶°‡¶ø‡¶∏‡¶ø, ............................ ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶ï‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶á</h3><h4>‡¶ó‡ßã‡¶≤ ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶Æ‡ßá‡¶ú‡¶æ‡¶∞‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶≤‡¶ø‡¶™</h4>`;
        } else {
            header.innerHTML = ``; // ‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
        }

        tbody.innerHTML = "";
        let total = 0;
        let trees = new Set();

        items.forEach((i, idx) => {
            if (i.type !== typeFilter) return;
            if (JSON.stringify(i).toLowerCase().includes(search)) {
                let size = i.type == "log" ? `${i.v1}" x ${i.v2}'` : `${i.v1}" x ${i.ve}" x ${i.v2}'`;
                tbody.innerHTML += `
                <tr>
                    <td>${i.tree}/${i.piece}</td>
                    <td>${i.type.toUpperCase()}</td>
                    <td>${size}</td>
                    <td>${i.cft}</td>
                    <td class="no-print">
                        <button class="edit-btn" onclick="startEdit(${idx})">Edit</button>
                        <button class="del-btn" onclick="del(${idx})">X</button>
                    </td>
                </tr>`;
                total += i.cft;
                trees.add(i.tree);
            }
        });

        document.getElementById("summary").innerHTML = `<span>Trees: ${trees.size}</span> <span>Pieces: ${items.filter(i=>i.type===typeFilter).length}</span> <span>Total CFT: ${total.toFixed(2)}</span>`;
    }

    function startEdit(idx) {
        let i = items[idx];
        editIndex = idx;
        document.getElementById("tree").value = i.tree;
        document.getElementById("piece").value = i.piece;
        document.getElementById("type").value = i.type;
        document.getElementById("v1").value = i.v1;
        document.getElementById("v2").value = i.v2;
        document.getElementById("ve").value = i.ve;
        toggleType();
        document.getElementById("addBtn").innerText = "Update Item (‚úî)";
        document.getElementById("addBtn").style.background = "#1565c0";
        document.getElementById("v1").focus();
    }

    function del(i) {
        if (confirm("Delete this item?")) {
            items.splice(i, 1);
            localStorage.setItem("wood_pro", JSON.stringify(items));
            render();
        }
    }

    function clearAll() {
        if (confirm("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
            items = [];
            localStorage.removeItem("wood_pro");
            render();
        }
    }

    function toggleDark() { document.body.classList.toggle("dark"); }

    function exportExcel() {
        let ws = XLSX.utils.json_to_sheet(items);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "WoodData");
        XLSX.writeFile(wb, "Wood_Report.xlsx");
    }

    function exportDoc() {
        let content = document.getElementById("print-content").innerHTML;
        let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border-collapse:collapse; width:100%;} th, td{border:1px solid black; padding:5px; text-align:center;}</style></head><body>";
        let blob = new Blob(['\ufeff', header + content + "</body></html>"], { type: 'application/msword' });
        saveAs(blob, "Wood_Report.doc");
    }

    render();
</script>

</body>
</html>
