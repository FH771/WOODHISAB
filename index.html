<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC ULTRA ERP - LOGIN FIXED</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
@font-face { font-family: 'SutonnyMJ'; src: local('SutonnyMJ'), local('SutonnyMJ-Bold'); }
body{font-family:'Segoe UI',Arial,sans-serif;background:#0f172a;margin:0;color:white}

/* UI ELEMENTS */
header{background:#020617;padding:12px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
.card{background:white;margin:15px;padding:15px;border-radius:12px;color:black;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
input,select,button{padding:12px;border-radius:8px;border:1px solid #cbd5e1;margin-top:8px;width:100%;box-sizing:border-box}
button{background:#22c55e;color:white;font-weight:bold;cursor:pointer;border:none}
button:hover{opacity:.9}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}

/* LOGIN SCREEN */
#loginPanel {position:fixed;inset:0;background:rgba(2,6,23,0.98);display:flex;align-items:center;justify-content:center;z-index:3000}
.box{background:#1e293b;padding:25px;border-radius:14px;width:90%;max-width:340px;color:white}
.hidden{display:none!important}

/* ADMIN POPUP */
#adminPanel { position:fixed; top:60px; right:15px; background:#1e293b; padding:15px; border-radius:10px; border:1px solid #22c55e; z-index:1500; width:250px; }

/* A4 & COLUMN FLOW */
.page { background: white; width: 210mm; min-height: 297mm; margin: 10px auto; padding: 10mm; color: black; box-sizing: border-box; }
.report-header{text-align:center; font-family:'SutonnyMJ'; margin-bottom:15px; line-height:1.2}
.multi-column { column-count: 2; column-gap: 30px; column-fill: auto; height: 230mm; }
table{width:100%;border-collapse:collapse;border:2px solid black}
th,td{border:1.2px solid black;padding:5px;text-align:center;font-size:14px}
.summary{display:flex;justify-content:space-between;border:2px solid black;padding:10px;margin-top:10px;font-weight:bold}

@media print {
    header, .no-print, #adminPanel, #saveStatus, .btn-edit, #adminToggle {display:none!important}
    body{background:white}
    .page{margin:0;width:100%;border:none}
}
</style>
</head>
<body>

<div id="loginPanel">
  <div class="box">
    <h2 style="text-align:center">BFIDC ERP LOGIN</h2>
    <input type="text" id="userInput" placeholder="User ID">
    <input type="password" id="passInput" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
    <p style="font-size:11px; text-align:center; color:#94a3b8; margin-top:10px">Default: admin | 0000</p>
  </div>
</div>

<div id="app" class="hidden">
<header>
    <div id="whoInfo"></div>
    <div style="font-weight:bold">üî• ULTRA BOSS ERP</div>
    <div style="display:flex; gap:10px">
        <button id="adminToggle" class="hidden" onclick="toggleAdminPanel()" style="background:#f59e0b; width:auto">‚öôÔ∏è Users</button>
        <button onclick="backup()" style="background:#3b82f6; width:auto">Backup</button>
        <button onclick="logout()" style="background:#ef4444; width:auto">Logout</button>
    </div>
</header>

<div id="adminPanel" class="hidden">
    <h4 style="margin:0 0 10px 0; color:#22c55e">User Management</h4>
    <input id="newID" placeholder="New User ID">
    <input id="newPass" type="password" placeholder="New Password">
    <button onclick="addUser()" style="margin-top:5px">Add / Reset</button>
    <hr style="border:0.5px solid #334155; margin:10px 0">
    <div id="userList" style="font-size:11px; max-height:100px; overflow:auto"></div>
</div>

<div class="container">
    <div class="card no-print">
        <div class="grid">
            <div><label>Tree No</label><input id="tree" value="1" class="nav-item"></div>
            <div><label>Type</label>
                <select id="type" onchange="toggleInputs()">
                    <option value="log">Round Log</option>
                    <option value="wood">Sawn Wood</option>
                </select>
            </div>
            <div><label id="lbl1">Girth (Inch)</label><input id="v1" class="nav-item"></div>
            <div id="ve-box" class="hidden"><label>Thickness</label><input id="ve" class="nav-item"></div>
            <div><label>Length (Foot)</label><input id="v2" class="nav-item"></div>
        </div>
        <button id="addBtn" onclick="addItem()" style="margin-top:15px">ADD DATA (+)</button>
        <div class="grid" style="margin-top:10px">
            <button onclick="exportExcel()" style="background:#16a34a">Excel</button>
            <button onclick="window.print()" style="background:#475569">Print A4</button>
            <button onclick="setFileName()" style="background:#f59e0b">Set Name</button>
            <button onclick="clearAll()" style="background:#dc2626">Clear All</button>
        </div>
        <p id="saveStatus" style="text-align:right;color:#16a34a;font-weight:bold;margin:5px 0 0 0;font-size:12px"></p>
    </div>
    <input id="search" placeholder="Search tree..." oninput="render()" class="card no-print" style="width:calc(100% - 30px)">
    <div id="printArea"></div>
</div>
</div>

<script>
/* ===== SECURITY & LOGIN ENGINE ===== */
async function hash(t){ const e=new TextEncoder().encode(t); const b=await crypto.subtle.digest('SHA-256',e); return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''); }

async function initUsers(){
    if(!localStorage.getItem("users")){
        let h = await hash("0000"); // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° 0000
        localStorage.setItem("users", JSON.stringify({ "admin": h }));
    }
}
initUsers();

async function handleLogin(){
    let id = document.getElementById("userInput").value.trim().toLowerCase();
    let pass = document.getElementById("passInput").value.trim();
    
    if(!id || !pass) return alert("Please enter ID and Password");
    
    let hashedPass = await hash(pass);
    let users = JSON.parse(localStorage.getItem("users"));
    
    if(users[id] && users[id] === hashedPass){
        sessionStorage.setItem("activeUser", id);
        startApp();
    } else { 
        alert("‡¶≠‡ßÅ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); 
    }
}

function startApp(){
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    let user = sessionStorage.getItem("activeUser");
    document.getElementById("whoInfo").innerText = "User: " + user.toUpperCase();
    if(user === 'admin') {
        document.getElementById("adminToggle").classList.remove("hidden");
        updateUserList();
    }
    render();
}

function logout(){ sessionStorage.clear(); location.reload(); }

/* ===== ADMIN PANEL FUNCTIONS ===== */
function toggleAdminPanel(){ document.getElementById("adminPanel").classList.toggle("hidden"); }

async function addUser(){
    let id = document.getElementById("newID").value.trim().toLowerCase();
    let pass = document.getElementById("newPass").value.trim();
    if(!id || !pass) return alert("Fill ID and Pass");
    let users = JSON.parse(localStorage.getItem("users"));
    users[id] = await hash(pass);
    localStorage.setItem("users", JSON.stringify(users));
    alert("User "+id+" created/updated!");
    updateUserList();
}

function updateUserList(){
    let users = JSON.parse(localStorage.getItem("users"));
    document.getElementById("userList").innerHTML = Object.keys(users).map(u => `‚Ä¢ ${u.toUpperCase()}`).join('<br>');
}

/* ===== ERP DATA ENGINE ===== */
let items = JSON.parse(localStorage.getItem("bfidc_data")) || [];
let editIdx = null;
let fileName = localStorage.getItem("bfidc_fname") || "Stock_File";

function toggleInputs(){
    let isLog = document.getElementById("type").value === 'log';
    document.getElementById("ve-box").classList.toggle("hidden", isLog);
    document.getElementById("lbl1").innerText = isLog ? "Girth (Inch)" : "Width (Inch)";
    render();
}

function save(){
    localStorage.setItem("bfidc_data", JSON.stringify(items));
    document.getElementById("saveStatus").innerText = "‚úî Saved: " + fileName;
}

function setFileName(){ let n = prompt("File Name:", fileName); if(n){ fileName=n; localStorage.setItem("bfidc_fname", n); save(); } }

function addItem(){
    let t = document.getElementById("tree").value;
    let ty = document.getElementById("type").value;
    let v1v = parseFloat(document.getElementById("v1").value);
    let v2v = parseFloat(document.getElementById("v2").value);
    let vev = parseFloat(document.getElementById("ve").value)||0;
    
    if(!v1v || !v2v) return alert("Data missing!");
    
    let cft = ty==='log' ? ((v1v/4)**2*v2v)/144 : (v1v*vev*v2v)/144;
    let piece = editIdx!==null ? items[editIdx].piece : (items.filter(i=>i.tree==t).length + 1);
    
    let obj = {tree:t, piece:piece, type:ty, v1:v1v, v2:v2v, ve:vev, cft:+cft.toFixed(2)};
    
    if(editIdx!==null){ items[editIdx]=obj; editIdx=null; document.getElementById("addBtn").innerText="ADD DATA (+)"; }
    else items.push(obj);
    
    save(); render();
    document.getElementById("v1").value=""; document.getElementById("v2").value=""; document.getElementById("ve").value="";
    document.getElementById("v1").focus();
}

function startEdit(idx){
    let i = items[idx]; editIdx = idx;
    document.getElementById("tree").value=i.tree; 
    document.getElementById("type").value=i.type; 
    document.getElementById("v1").value=i.v1; 
    document.getElementById("v2").value=i.v2; 
    document.getElementById("ve").value=i.ve;
    document.getElementById("addBtn").innerText="UPDATE DATA (‚úî)"; toggleInputs();
}

function render(){
    let s = document.getElementById("search").value.toLowerCase();
    let tyVal = document.getElementById("type").value;
    let filtered = items.filter(i => i.type === tyVal && i.tree.toString().includes(s));
    
    let total=0, trees=new Set();
    filtered.forEach(i=>{ total+=i.cft; trees.add(i.tree); });

    let header = tyVal==='log' ? `
        <div class="report-header">
            <h3>weGdAvBwWwm, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ivevi evMvb n‚Ä°Z weGdAvBwWwm, Gjwcwm, Kv√üvB</h3>
            <h3>‚Ä°c¬´i‚Ä°Yi Rb¬® KZ¬©bK‚Ä¶Z RxebP¬µ nviv‚Ä°bv ivevi Kv‚Ä°Vi mvBR wj√∑|</h3>
        </div>` : `<div style="height:30px"></div>`;

    let html = `<div class="page">${header}<div class="multi-column"><table><tr><th>Tree/Pc</th><th>Size</th><th>CFT</th><th class="no-print">‚öô</th></tr>`;
    filtered.forEach((i) => {
        let size = i.type==='log' ? `${i.v1}"x${i.v2}'` : `${i.v1}"x${i.ve}"x${i.v2}'`;
        html += `<tr><td>${i.tree}/${i.piece}</td><td>${size}</td><td>${i.cft}</td><td class="no-print"><button style="padding:2px 5px;font-size:10px;width:auto;background:#3b82f6" onclick="startEdit(${items.indexOf(i)})">Edit</button></td></tr>`;
    });
    html += `</table></div><div class="summary"><span>Trees: ${trees.size}</span><span>Pieces: ${filtered.length}</span><span>Total: ${total.toFixed(2)} CFT</span></div></div>`;
    document.getElementById("printArea").innerHTML = html;
}

function exportExcel(){let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(items),"Data"); XLSX.writeFile(wb,fileName+".xlsx")}
function backup(){let b=new Blob([JSON.stringify(localStorage)],{type:"application/json"}); let a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="BFIDC_BACKUP.json"; a.click();}
function clearAll(){if(confirm("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")){items=[]; save(); render();}}

document.addEventListener('keydown', e => {
    let nav = Array.from(document.querySelectorAll('.nav-item')).filter(i=>!i.parentElement.classList.contains('hidden'));
    let idx = nav.indexOf(document.activeElement);
    if(e.key === 'Enter' && idx > -1){
        e.preventDefault();
        if(document.activeElement.id === 'v2') addItem();
        else nav[idx+1]?.focus();
    }
});

if(sessionStorage.getItem("activeUser")) startApp();
</script>
</body>
</html>
