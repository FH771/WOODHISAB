<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFIDC Wood System ULTRA PRO</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
@page{size:A4;margin:10mm}
body{font-family:Segoe UI;margin:0;background:#eef2f7}
.dark{background:#121212;color:white}
header{position:sticky;top:0;background:#2e7d32;color:white;padding:10px;display:flex;justify-content:space-between}
.card{background:white;margin:10px auto;padding:12px;border-radius:10px;max-width:1100px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
input,select,button{padding:10px;border-radius:8px;border:1px solid #ccc}
button{background:#2e7d32;color:white;border:none;cursor:pointer}
.page{background:white;width:210mm;min-height:297mm;margin:10px auto;padding:10mm;border:1px solid #ddd}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid black;padding:4px;text-align:center}
.summary{border:2px solid black;padding:10px;margin-top:10px;font-weight:bold;display:flex;justify-content:space-between}
@media print{header,.no-print{display:none}.page{margin:0;border:none}}
</style>
</head>
<body>

<header>
<span>BFIDC Wood ULTRA PRO üå≤</span>
<div>
<button onclick="toggleDark()">üåô</button>
<button onclick="installApp()">Install</button>
<button onclick="logout()">Logout</button>
</div>
</header>

<div class="card no-print">
<div class="grid">
<input id="tree" placeholder="‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç">
<input id="piece" placeholder="‡¶™‡¶ø‡¶∏" readonly>
<select id="type" onchange="toggleInputs()">
<option value="log">‡¶ó‡ßã‡¶≤</option>
<option value="wood">‡¶∏‡¶æ‡¶á‡¶ú</option>
</select>
<input id="v1" placeholder="‡¶¨‡ßá‡¶°‡¶º / ‡¶ö‡¶ì‡¶°‡¶º‡¶æ">
<input id="ve" placeholder="‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨">
<input id="v2" placeholder="‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ">
<input id="search" placeholder="üîé Search" oninput="render()">
</div>

<div class="grid" style="margin-top:8px">
<button onclick="addItem()">Add</button>
<button onclick="exportExcel()">Excel</button>
<button onclick="exportPDF()">PDF</button>
<button onclick="dailyReport()">Daily Report</button>
<button onclick="window.print()">Print</button>
<button onclick="clearAll()" style="background:#c62828">Clear</button>
</div>
</div>

<div id="pages"></div>

<script>

// INSTALLABLE APP
let deferredPrompt;
window.addEventListener('beforeinstallprompt',(e)=>{
e.preventDefault();
deferredPrompt=e;
});

async function installApp(){
if(!deferredPrompt) return alert("Install not available yet");
deferredPrompt.prompt();
}

// SERVICE WORKER
if('serviceWorker' in navigator){
navigator.serviceWorker.register('sw.js').catch(()=>{});
}

// AUTO SAVE
let items=JSON.parse(localStorage.getItem("wood_ultra"))||[];
function save(){localStorage.setItem("wood_ultra",JSON.stringify(items));}

function autoPiece(tree){return items.filter(i=>i.tree==tree).length+1;}

function toggleInputs(){
ve.style.display=type.value==="wood"?"block":"none";
}

function addItem(){
let tree=treeEl().value;
let type=typeEl().value;
let v1=parseFloat(v1El().value);
let v2=parseFloat(v2El().value);
let ve=parseFloat(veEl().value)||0;

if(!tree||!v1||!v2) return alert("Missing data");

if(items.find(i=>i.tree==tree&&i.v1==v1&&i.v2==v2&&i.ve==ve))
return alert("Duplicate entry!");

let piece=autoPiece(tree);

let cft=type==="log"
?((v1/4)**2*v2)/144
:(v1*ve*v2)/144;

items.push({tree,piece,type,v1,v2,ve,cft:+cft.toFixed(2),date:new Date().toLocaleDateString()});

save();
render();

pieceEl().value=autoPiece(tree);
v1El().value="";v2El().value="";veEl().value="";
}

function render(){
let s=search.value?.toLowerCase()||"";
let filtered=items.filter(i=>JSON.stringify(i).toLowerCase().includes(s));

let total=0;let trees=new Set();

let html=`<div class='page'><table>
<tr><th>‡¶ï‡ßç‡¶∞.‡¶®‡¶Ç</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶™</th><th>CFT</th><th>‚ùå</th></tr>`;

filtered.forEach((i,idx)=>{
let m=i.type==="log"
?`${i.v1}" x ${i.v2}'`
:`${i.v1}" x ${i.ve}" x ${i.v2}'`;

html+=`<tr>
<td>${i.tree}/${i.piece}</td>
<td>${m}</td>
<td>${i.cft}</td>
<td><button onclick="del(${idx})">X</button></td>
</tr>`;

total+=i.cft;trees.add(i.tree);
});

html+=`</table>
<div class='summary'>
<span>‡¶ó‡¶æ‡¶õ: ${trees.size}</span>
<span>‡¶™‡¶ø‡¶∏: ${filtered.length}</span>
<span>‡¶Æ‡ßã‡¶ü: ${total.toFixed(2)} CFT</span>
</div></div>`;

pages.innerHTML=html;
}

function dailyReport(){
let today=new Date().toLocaleDateString();
let todayItems=items.filter(i=>i.date===today);
let total=todayItems.reduce((a,b)=>a+b.cft,0);
alert(`Today Pieces: ${todayItems.length}\nTotal CFT: ${total.toFixed(2)}`);
}

function del(i){if(confirm("Delete?")){items.splice(i,1);save();render();}}
function clearAll(){if(confirm("Clear all?")){items=[];save();render();}}
function toggleDark(){document.body.classList.toggle("dark");}

function exportExcel(){
let ws=XLSX.utils.json_to_sheet(items);
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Wood");
XLSX.writeFile(wb,"wood_report.xlsx");
}

async function exportPDF(){
const {jsPDF}=window.jspdf;
let doc=new jsPDF();
let y=10;
items.forEach(i=>{doc.text(`${i.tree}/${i.piece} ${i.cft} CFT`,10,y);y+=8;});
doc.save("wood.pdf");
}

function treeEl(){return tree}
function pieceEl(){return piece}
function typeEl(){return type}
function v1El(){return v1}
function v2El(){return v2}
function veEl(){return ve}

render();
</script>
</body>
</html>

<!-- SERVICE WORKER FILE -->
<!-- Save as sw.js in same folder -->
<script type="text/plain" id="swfile">
self.addEventListener('install',e=>{
e.waitUntil(caches.open('wood-cache').then(cache=>cache.addAll(['./'])));
});
self.addEventListener('fetch',e=>{
e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});
</script>

<!-- MANIFEST FILE -->
<script type="text/plain" id="manifestfile">
{
"name":"BFIDC Wood Manager",
"short_name":"WoodPro",
"start_url":".",
"display":"standalone",
"background_color":"#2e7d32",
"theme_color":"#2e7d32",
"icons":[{
"src":"https://cdn-icons-png.flaticon.com/512/2909/2909767.png",
"sizes":"192x192",
"type":"image/png"
}]
}
</script>
