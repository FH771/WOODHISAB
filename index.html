<!DOCTYPE html><html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>BFIDCWOODHISAB v2 Pro Max</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--primary:#22c55e;--secondary:#10b981;--dark:#020617;--card:#0f172a;--danger:#ef4444;--info:#3b82f6;--font:'Kalpurush',sans-serif;}
@font-face{font-family:'Kalpurush';src:url('https://cdn.jsdelivr.net/gh/at-shovo/bangla-fonts/Kalpurush/Kalpurush.ttf') format('truetype');}
body{margin:0;font-family:var(--font);background:linear-gradient(135deg,#020617,#0f172a);color:white;-webkit-print-color-adjust:exact;}
/* Full CSS from previous version included here */
</style>
</head>
<body><div id="loginLayer">
    <div class="login-box">
        <h2>BFIDCWOODHISAB v2 Pro Max</h2>
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') handleAuth()">
        <button onclick="handleAuth()" id="mainBtn">Create Admin</button>
        <div class="toggle" onclick="toggleMode()" id="toggleText"></div>
        <div class="msg" id="msg"></div>
    </div>
</div><div id="appArea">
    <!-- Header -->
    <header>
        <div class="logo-area">
            <img src="logo.jpg" class="header-logo" alt="L">
            <div class="logo">BFIDCWOODHISAB</div>
        </div>
        <div class="btn-group">
            <button class="action-btn" onclick="document.getElementById('importFile').click()">Upload</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            <button class="action-btn" onclick="changePass()">Change</button>
            <button class="action-btn" onclick="exportExcel()" style="background:var(--secondary)">Excel</button>
            <button class="action-btn" onclick="exportWord()" style="background:var(--info)">Word</button>
            <button class="action-btn" onclick="backup()" style="background:var(--primary)">Save</button>
            <button class="action-btn" onclick="logout()" style="background:var(--danger)">Logout</button>
        </div>
    </header><!-- Dashboard -->
<div class="dashboard no-print">
    <div class="stat"><h2><span id="treeStat">0</span></h2><p>Trees</p></div>
    <div class="stat"><h2><span id="pieceStat">0</span></h2><p>Pieces</p></div>
    <div class="stat"><h2><span id="cftStat">0.00</span></h2><p>Total CFT</p></div>
</div>

<!-- Input Card -->
<div class="card no-print">
    <div class="grid">
        <div>গাছ নং<input id="treeInput" type="number" value="1" oninput="updatePiece()"></div>
        <div>টাইপ
            <select id="typeInput" onchange="toggleInputs()">
                <option value="log">Round Log</option>
                <option value="size">Sawn Wood</option>
            </select>
        </div>
        <div>পিস নং<input id="pieceInput" readonly style="opacity:0.6"></div>
    </div>
    <div class="grid" style="margin-top:10px">
        <div id="girthBox">বেড় (ইঞ্চি)<input id="v1Input" type="number" step="any"></div>
        <div id="thickBox" style="display:none">
            <div style="display:flex; gap:5px">
                <div style="flex:1">চওড়া<input id="widthInput" type="number" step="any"></div>
                <div style="flex:1">পুরুত্ব<input id="thickInput" type="number" step="any"></div>
            </div>
        </div>
        <div>লম্বা (ফুট)<input id="v2Input" type="number" step="any"></div>
        <div style="display:flex; align-items:flex-end">
            <button id="saveBtn" onclick="addItem()" style="height:45px">SAVE (ENTER)</button>
        </div>
    </div>
</div>

<!-- Charts -->
<div id="chartsContainer" class="no-print">
    <div class="chart-card"><canvas id="cftChart"></canvas></div>
    <div class="chart-card"><canvas id="typeChart"></canvas></div>
</div>

<!-- Report -->
<div id="printArea"></div>

</div><script>
// LOGIN / ACCOUNT SYSTEM
let mode="register";
window.onload=function(){
    let users=JSON.parse(localStorage.getItem("bfidc_users")||"[]");
    if(users.length>0){mode="login";mainBtn.innerText="Login";toggleText.innerText="Create new account";}else{toggleText.innerText="First user will be Admin";}
    if(sessionStorage.getItem("bfidc_loggedIn")==="true"){loginLayer.style.display="none"; appArea.style.display="block"; render(); updatePiece(); renderCharts();}
}
function toggleMode(){mode=mode==="login"?"register":"login"; mainBtn.innerText=mode==="login"?"Login":"Register"; toggleText.innerText=mode==="login"?"Create new account":"Already have account? Login";}
async function hashPassword(pass){const enc=new TextEncoder(); const data=enc.encode(pass); const hash=await crypto.subtle.digest("SHA-256",data); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function handleAuth(){
    const emailVal=email.value.trim(); const passVal=password.value.trim();
    if(!emailVal||!passVal){msg.innerText="Fill all fields"; return;}
    if(passVal.length<6){msg.innerText="Password min 6 chars"; return;}
    let users=JSON.parse(localStorage.getItem("bfidc_users")||"[]");
    const hashed=await hashPassword(passVal);
    if(mode==="register"){
        if(users.find(u=>u.email===emailVal)){msg.innerText="Account exists"; return;}
        const role=users.length===0?"admin":"staff";
        users.push({email:emailVal,password:hashed,role:role});
        localStorage.setItem("bfidc_users",JSON.stringify(users));
        msg.style.color="#4ade80"; msg.innerText="Account created! Login now."; toggleMode();
    }else{
        const user=users.find(u=>u.email===emailVal);
        if(!user){msg.innerText="User not found"; return;}
        if(user.password!==hashed){msg.innerText="Wrong password"; return;}
        sessionStorage.setItem("bfidc_loggedIn","true");
        sessionStorage.setItem("bfidc_role",user.role);
        sessionStorage.setItem("bfidc_email",user.email);
        msg.style.color="#4ade80"; msg.innerText="Login success!";
        setTimeout(()=>{loginLayer.style.display="none"; appArea.style.display="block"; render(); updatePiece(); renderCharts();},800);
    }
}
function logout(){sessionStorage.clear(); location.reload();}

// WOOD SYSTEM
let items=JSON.parse(localStorage.getItem('bfidc_data')||'[]');
const logoFile="logo.jpg";
function updatePiece(){pieceInput.value=items.filter(i=>i.tree==treeInput.value && i.type===typeInput.value).length+1;}
function toggleInputs(){thickBox.style.display=typeInput.value==='size'?'block':'none'; girthBox.style.display=typeInput.value==='size'?'none':'block';}
function addItem(){
    let t=parseInt(treeInput.value), v2v=parseFloat(v2Input.value), cft,v1v,th,wd;
    if(typeInput.value==='log'){
        v1v=parseFloat(v1Input.value); if(!t||!v1v||!v2v) return;
        cft=((v1v/4)**2*v2v)/144;
    }else{
        wd=parseFloat(widthInput.value); th=parseFloat(thickInput.value); if(!t||!wd||!th||!v2v) return;
        v1v=wd; cft=(wd*th*v2v)/144;
    }
    let obj={tree:t,piece:items.filter(i=>i.tree==t&&i.type===typeInput.value).length+1,type:typeInput.value,v1:v1v,v2:v2v,thick:th||0,cft:parseFloat(cft.toFixed(2))};
    items.push(obj); localStorage.setItem('bfidc_data',JSON.stringify(items));
    v1Input.value=v2Input.value=thickInput.value=widthInput.value='';
    render(); updatePiece(); treeInput.select(); renderCharts();
}
function render(){
    let keyword=searchInput.value?.toLowerCase()||'';
    let filtered=items.filter(i=>i.tree.toString().includes(keyword));
    let tTrees=new Set(filtered.map(i=>i.tree)).size;
    let tPieces=filtered.length;
    let tCft=filtered.reduce((s,i)=>s+i.cft,0).toFixed(2);
    treeStat.innerText=tTrees; pieceStat.innerText=tPieces; cftStat.innerText=tCft;

    const perPage=76; let html="";
    for(let p=0;p<filtered.length;p+=perPage){
        let pageData=filtered.slice(p,p+perPage);
        let left=pageData.slice(0,38), right=pageData.slice(38);
        let isLastPage=(p+perPage>=filtered.length);
        html+=`<div class="report-page"><img class="watermark" src="${logoFile}"><div style="display:flex;gap:10px;"><div style="flex:1"><table><tr><th>গাছ/পিস</th><th>মাপ</th><th>CFT</th></tr>${left.map(i=>`<tr><td>${i.tree}/${i.piece}</td><td>${i.type==='size'?i.v1+'"x'+i.thick+'"x'+i.v2+'"':i.v1+'"x'+i.v2+'"'}</td><td>${i.cft}</td></tr>`).join('')}</table></div><div style="flex:1"><table><tr><th>গাছ/পিস</th><th>মাপ</th><th>CFT</th></tr>${right.map(i=>`<tr><td>${i.tree}/${i.piece}</td><td>${i.type==='size'?i.v1+'"x'+i.thick+'"x'+i.v2+'"':i.v1+'"x'+i.v2+'"'}</td><td>${i.cft}</td></tr>`).join('')}</table></div></div>`;
        if(isLastPage){html+=`<div class="summary-box"><div>মোট গাছ: ${tTrees} টি</div><div>মোট পিস: ${tPieces} টি</div><div>মোট সিএফটি: ${tCft} cft</div></div>`;}
        html+=`<div style="position:absolute;bottom:10mm;right:15mm;font-size:12px">পৃষ্ঠা: ${Math.floor(p/perPage)+1}</div></div>`;
    }
    printArea.innerHTML=html;
}
function exportExcel(){let ws=XLSX.utils.json_to_sheet(items); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"BFIDC_Data.xlsx");}
function exportWord(){let content=document.getElementById('printArea').innerHTML; let blob=new Blob(['<html><head><meta charset="UTF-8"></head><body>'+content+'</body></html>'],{type:'application/msword'}); let url=URL.createObjectURL(blob); let a=document.createElement('a'); a.href=url; a.download='BFIDC_Report.doc'; a.click();}
function backup(){let blob=new Blob([JSON.stringify(items)],{type:'application/json'}); let a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='BFIDC_Backup.json'; a.click();}
function importData(event){const reader=new FileReader(); reader.onload=(e)=>{items=JSON.parse(e.target.result); localStorage.setItem('bfidc_data',JSON.stringify(items)); render(); updatePiece(); renderCharts(); alert("Data Uploaded!");}; reader.readAsText(event.target.files[0]);}
function renderCharts(){
    const ctxCft=document.getElementById('cftChart').getContext('2d');
    const ctxType=document.getElementById('typeChart').getContext('2d');
    const treeLabels=[...new Set(items.map(i=>i.tree))];
    const treeCfts=treeLabels.map(t=>items.filter(i=>i.tree==t).reduce((s,i)=>s+i.cft,0));
    const typeCounts=[items.filter(i=>i.type==='log').length, items.filter(i=>i.type==='size').length];
    if(window.cftChartObj) window.cftChartObj.destroy();
    window.cftChartObj=new Chart(ctxCft,{type:'bar',data:{labels:treeLabels,datasets:[{label:'CFT per Tree',data:treeCfts,backgroundColor:'#22c55e'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
    if(window.typeChartObj) window.typeChartObj.destroy();
    window.typeChartObj=new Chart(ctxType,{type:'pie',data:{labels:['Round Log','Sawn Wood'],datasets:[{data:typeCounts,backgroundColor:['#10b981','#3b82f6']}]},options:{responsive:true}});
}
</script></body>
</html>
