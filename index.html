<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BFIDC WOOD HISAB ELITE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body{ margin:0; font-family:Poppins, sans-serif; background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:white; min-height:100vh; } 
        .container{padding:20px} 
        .card{ background:rgba(255,255,255,0.08); padding:20px; border-radius:18px; backdrop-filter:blur(12px); margin-bottom:20px; box-shadow:0 10px 30px rgba(0,0,0,.3); } 
        input,select,button{ width:100%; padding:12px; margin-top:10px; border-radius:10px; border:none; font-size:15px; box-sizing: border-box; } 
        button{ background:#00ffd5; font-weight:600; cursor:pointer; color: #0f2027; } 
        .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px} 
        .stat{background:rgba(255,255,255,.12);padding:15px;border-radius:14px;text-align:center} 
        #appArea, #adminPanel, #thickInput{display:none} 
        .error{color:#ff8080;margin-top:10px; text-align:center; font-weight: bold;}
    </style>
</head>
<body>

<div class="container">
    <div id="loginLayer" class="card">
        <h2 style="text-align:center">BFIDC Login</h2>
        <input type="email" id="emailInput" placeholder="Email (lpcfahad7@gmail.com)">
        <input type="password" id="passwordInput" placeholder="Password (547087)">
        <button onclick="handleAuth()">LOGIN</button>
        <div id="msg" class="error"></div>
    </div>

    <div id="appArea">
        <div class="stats card">
            <div class="stat"><small>Trees</small><br><b id="treeStat">0</b></div>
            <div class="stat"><small>Pieces</small><br><b id="pieceStat">0</b></div>
            <div class="stat"><small>Total CFT</small><br><b id="cftStat">0</b></div>
        </div>

        <div class="card">
            <h3>Add Wood</h3>
            <select id="typeInput" onchange="toggleInputs()">
                <option value="log">Round Log</option>
                <option value="sawn">Sawn Wood</option>
            </select>
            <input type="number" id="treeInput" placeholder="Tree No">
            <input type="number" id="pieceInput" placeholder="Piece No" readonly>
            <input type="number" id="v1Input" placeholder="Girth / Width (inch)">
            <input type="number" id="thickInput" placeholder="Thickness (inch)">
            <input type="number" id="v2Input" placeholder="Length (feet)">
            <button onclick="addItem()">SAVE</button>
        </div>

        <canvas id="chart" class="card"></canvas>

        <div class="card">
            <button onclick="backup()" style="background:#ffcc00">Backup JSON</button>
            <button onclick="exportExcel()" style="background:#ffffff">Export Excel</button>
            <button onclick="logout()" style="background:#ff4d4d; color:white; margin-top:20px">Logout</button>
        </div>

        <div id="adminPanel" class="card" style="border: 2px solid #00ffd5;">
            <h3>Admin Panel</h3>
            <input type="email" id="newUserEmail" placeholder="New Staff Email">
            <input type="password" id="newUserPass" placeholder="New Staff Password">
            <button onclick="createUser()">Create Staff</button>
            <button onclick="deleteUsers()" style="background:#ff8080; margin-top:10px">Delete All Staff</button>
        </div>
    </div>
</div>

<script>
/* SECURE HASH */
function hash(p){
    let h=0;
    for(let i=0;i<p.length;i++){
        h=((h<<5)-h)+p.charCodeAt(i);
        h&=h;
    }
    return String(h); 
}

/* FORCE SETUP ADMIN */
function ensureAdmin(){
    // Clearing any old broken user data and setting fresh admin
    let users = [];
    users.push({
        email: 'lpcfahad7@gmail.com',
        pass: hash('547087'),
        role: 'admin'
    });
    // Staff গুলোকে আগের ডাটা থেকে ফিরিয়ে আনা (যদি থাকে)
    let oldUsers = JSON.parse(localStorage.getItem('users') || '[]');
    oldUsers.forEach(u => {
        if(u.email !== 'lpcfahad7@gmail.com') users.push(u);
    });
    
    localStorage.setItem('users', JSON.stringify(users));
}

/* AUTH SYSTEM */
function handleAuth(){
    const email = document.getElementById('emailInput').value.trim().toLowerCase();
    const passInput = document.getElementById('passwordInput').value.trim();
    const hashedPass = hash(passInput);
    
    let users = JSON.parse(localStorage.getItem('users') || '[]');
    let user = users.find(u => u.email === email && u.pass === hashedPass);
    
    if(user){
        sessionStorage.setItem('user', JSON.stringify(user));
        startApp(user);
    } else {
        document.getElementById('msg').innerText = 'Invalid Email or Password!';
    }
}

function startApp(user){
    document.getElementById('loginLayer').style.display='none';
    document.getElementById('appArea').style.display='block';
    if(user.role==='admin') document.getElementById('adminPanel').style.display='block';
    render();
    drawChart();
}

window.onload = () => {
    ensureAdmin(); // Always refresh admin on load
    let savedUser = sessionStorage.getItem('user');
    if(savedUser) startApp(JSON.parse(savedUser));
}

function logout(){
    sessionStorage.clear();
    location.reload();
}

/* ADMIN PANEL FUNCTIONS */
function createUser(){
    let users = JSON.parse(localStorage.getItem('users')||'[]');
    let e = document.getElementById('newUserEmail').value.toLowerCase().trim();
    let p = document.getElementById('newUserPass').value.trim();
    if(!e || !p) { alert('Fill all fields'); return; }
    users.push({email:e, pass:hash(p), role:'staff'});
    localStorage.setItem('users', JSON.stringify(users));
    alert('Staff Created');
    document.getElementById('newUserEmail').value='';
    document.getElementById('newUserPass').value='';
}

function deleteUsers(){
    if(confirm('Delete all staff?')){
        let users = JSON.parse(localStorage.getItem('users')||'[]');
        users = users.filter(u => u.role === 'admin');
        localStorage.setItem('users', JSON.stringify(users));
        alert('Done');
    }
}

/* DATA LOGIC */
let items = JSON.parse(localStorage.getItem('data')||'[]');

function toggleInputs(){
    let type = document.getElementById('typeInput').value;
    document.getElementById('thickInput').style.display = (type==='log') ? 'none' : 'block';
}

document.getElementById('treeInput').addEventListener('input', function(){
    let t = this.value;
    document.getElementById('pieceInput').value = items.filter(i=>i.tree == t).length + 1;
});

function addItem(){
    let tree = document.getElementById('treeInput').value;
    let g = +document.getElementById('v1Input').value;
    let len = +document.getElementById('v2Input').value;
    let type = document.getElementById('typeInput').value;
    let th = +document.getElementById('thickInput').value || 0;
    
    if(!tree || !g || !len) return;

    let cft = (type==='log') ? ((g/4)**2 * len)/144 : (g * th * len)/144;
    items.push({tree, piece: document.getElementById('pieceInput').value, cft: +cft.toFixed(2), type});
    localStorage.setItem('data', JSON.stringify(items));
    render();
    drawChart();
    document.getElementById('pieceInput').value = items.filter(i=>i.tree == tree).length + 1;
}

function render(){
    document.getElementById('treeStat').innerText = new Set(items.map(i=>i.tree)).size;
    document.getElementById('pieceStat').innerText = items.length;
    document.getElementById('cftStat').innerText = items.reduce((s,i)=>s+i.cft,0).toFixed(2);
}

let chart;
function drawChart(){
    let map = {};
    items.forEach(i=> map[i.tree] = (map[i.tree]||0) + i.cft);
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('chart'), {
        type:'bar',
        data:{
            labels:Object.keys(map),
            datasets:[{label:'Total CFT', data:Object.values(map), backgroundColor:'#00ffd5'}]
        }
    });
}

function backup(){
    let blob = new Blob([JSON.stringify(items)], {type:'application/json'});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'BFIDC_DATA.json';
    a.click();
}

function exportExcel(){
    let ws = XLSX.utils.json_to_sheet(items);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "BFIDC_Wood_Report.xlsx");
}
</script>
</body>
</html>
