<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>BFIDC ERP - FAST NAVIGATION</title>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
@font-face { font-family: 'Kalpurush'; src: url('https://cdn.jsdelivr.net/gh/at-shovo/bangla-fonts/Kalpurush/Kalpurush.ttf') format('truetype'); }
body{font-family: 'Segoe UI', Arial, sans-serif; background:#0f172a; margin:0; color:white; -webkit-tap-highlight-color: transparent;}
header{position:sticky; top:0; background:#020617; padding:10px; display:flex; justify-content:space-between; align-items:center; z-index:999;}
.card{background:white; padding:15px; border-radius:12px; margin:10px; color:black;}
.grid-inputs{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px}
input, select { width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box; font-size:16px; }
input:focus { border-color:#22c55e; outline:none; background:#f0fdf4; }

.report-header { text-align: center; margin-bottom: 15px; font-family: 'Kalpurush', sans-serif; color: black; }
.report-header h3 { margin: 2px 0; font-size: 20px; font-weight: normal; }
.page { background: white; width: 210mm; min-height: 297mm; margin: 10px auto; padding: 10mm; color: black; box-sizing: border-box; display: flex; flex-direction: column; }
.multi-column { column-count: 2; column-gap: 30px; flex-grow: 1; }
table { width: 100%; border-collapse: collapse; border: 2px solid #000; }
th, td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 13px; font-family: 'Kalpurush', sans-serif; }
.summary-container { margin-top: auto; padding-top: 20px; }
.summary-table { width: 50%; border: 2px solid #000; }
.summary-table td { font-weight: bold; font-size: 15px; padding: 8px; text-align: left; }
.btn-del { background:#ef4444; color:white; border:none; padding:4px 8px; border-radius:4px; }
.btn-edit { background:#f59e0b; color:white; border:none; padding:4px 8px; border-radius:4px; margin-right:4px; }
.hidden { display:none!important; }
@media print { header, .no-print, #loginLayer {display:none!important} .page { margin: 0; border: none; width: 100%; page-break-after: always; } }
</style>
</head>
<body>

<div id="loginLayer" style="position:fixed; inset:0; background:#020617; display:flex; align-items:center; justify-content:center; z-index:9999">
  <div style="background:#111827; padding:25px; border-radius:14px; width:90%; max-width:320px; text-align:center">
    <h2 style="color:white; margin-bottom:20px">BFIDC LOGIN</h2>
    <input id="uID" placeholder="User ID" style="margin-bottom:10px;">
    <input id="uPass" type="password" placeholder="Password" style="margin-bottom:15px;">
    <button onclick="handleLogin()" style="width:100%; padding:12px; background:#22c55e; color:white; font-weight:bold; border:none; border-radius:8px;">Login</button>
  </div>
</div>

<div id="appArea" class="hidden">
<header>
    <div id="who" style="font-size: 11px;"></div>
    <div style="display:flex; gap:5px">
        <button id="auth_btn" onclick="handleAuthClick()" style="background:#1a73e8; color:white; border:none; padding:5px 8px; border-radius:4px; font-size:10px">‚òÅÔ∏è DRIVE LOGIN</button>
        <button id="sync_btn" onclick="saveToDrive()" class="hidden" style="background:#34a853; color:white; border:none; padding:5px 8px; border-radius:4px; font-size:10px">üì§ SYNC</button>
        <button id="load_btn" onclick="loadFromDrive()" class="hidden" style="background:#fbbc05; color:white; border:none; padding:5px 8px; border-radius:4px; font-size:10px">üì• LOAD</button>
        <button onclick="logout()" style="background:#ef4444; color:white; border:none; padding:5px 8px; border-radius:4px; font-size:10px">X</button>
    </div>
</header>
<div id="sync_status" style="font-size: 11px; color: #4ade80; text-align: center; margin-top: 5px; font-weight: bold;"></div>

<div class="card no-print">
    <div class="grid-inputs">
        <div>‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç<input id="tree" value="1" onkeydown="move(event, 'v1')"></div>
        <div>‡¶™‡¶ø‡¶∏ ‡¶®‡¶Ç<input id="piece" readonly style="background:#e2e8f0"></div>
        <div style="grid-column: span 2">‡¶ß‡¶∞‡¶£
            <select id="type" onchange="toggleInputs()">
                <option value="log">‡¶ó‡ßã‡¶≤ ‡¶ï‡¶æ‡¶† (Round Log)</option>
                <option value="wood">‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶æ‡¶† (Sawn Wood)</option>
            </select>
        </div>
        <div><span id="labelV1">‡¶¨‡ßá‡ßú (‡¶á‡¶û‡ßç‡¶ö‡¶ø)</span><input id="v1" inputmode="decimal" onkeydown="move(event, 'v2')"></div>
        <div id="thickBox" class="hidden">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨ (‡¶á‡¶û‡ßç‡¶ö‡¶ø)<input id="ve" inputmode="decimal" onkeydown="move(event, 'v2')"></div>
        <div>‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ (‡¶´‡ßÅ‡¶ü)<input id="v2" inputmode="decimal" onkeydown="move(event, 'save')"></div>
    </div>
    <button onclick="addItem()" id="addBtn" style="width:100%; margin-top:12px; background:#22c55e; color:white; padding:15px; font-size:18px; border:none; border-radius:8px; font-weight:bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® (ENTER)</button>
</div>

<div id="printArea"></div>
</div>

<script>
// --- ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---
function move(e, next) {
    if (e.key === "Enter" || e.key === "ArrowDown") {
        e.preventDefault();
        // ‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡ßá‡ßú‡ßá (v1) ‡¶Ø‡¶æ‡¶¨‡ßá
        if (e.target.id === 'tree') {
            document.getElementById('v1').focus();
        } 
        // ‡¶ó‡ßã‡¶≤ ‡¶ï‡¶æ‡¶† ‡¶π‡¶≤‡ßá v1 ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø v2 ‡¶§‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá (‡¶™‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶¨‡ßá)
        else if (next === 'v2' && type.value === 'wood' && e.target.id === 'v1') {
            document.getElementById('ve').focus();
        } 
        // ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ (v2) ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá
        else if (next === 'save') {
            addItem();
        } else {
            document.getElementById(next).focus();
        }
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        let prev = (e.target.id === 'v2') ? (type.value === 'wood' ? 've' : 'v1') : (e.target.id === 've' ? 'v1' : 'tree');
        document.getElementById(prev).focus();
    }
}

// --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡¶ú‡¶ø‡¶ï ---
const CLIENT_ID = '234418632833-gv6d3hqpnfjeodsi21t2g6afkh81o95i.apps.googleusercontent.com'; 
const API_KEY = 'AIzaSyDvmF9t7WvsUvZLs5tFjGVfxTaQxsOKRJs'; 
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
let tokenClient, items = JSON.parse(localStorage.getItem("bfidc_data")) || [], editIdx = null;

function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS}); }); }
function gsiLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({client_id: CLIENT_ID, scope: SCOPES, callback: ''}); }
function handleAuthClick() {
    tokenClient.callback = async (resp) => { auth_btn.classList.add('hidden'); sync_btn.classList.remove('hidden'); load_btn.classList.remove('hidden'); sync_status.innerText = "‚òÅÔ∏è Connected"; };
    tokenClient.requestAccessToken({prompt: 'consent'});
}

async function saveToDrive() {
    sync_status.innerText = "Saving...";
    const res = await gapi.client.drive.files.list({ q: "name = 'wood_data.json' and trashed = false" });
    const blob = new Blob([JSON.stringify(items)], {type: 'application/json'});
    let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=media', method = (res.result.files.length > 0) ? 'PATCH' : 'POST';
    if(method === 'PATCH') url = `https://www.googleapis.com/upload/drive/v3/files/${res.result.files[0].id}?uploadType=media`;
    await fetch(url, { method: method, headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }, body: blob });
    sync_status.innerText = "‚úÖ Saved!";
}

async function loadFromDrive() {
    const res = await gapi.client.drive.files.list({ q: "name = 'wood_data.json' and trashed = false" });
    if (res.result.files.length > 0) {
        const file = await gapi.client.drive.files.get({ fileId: res.result.files[0].id, alt: 'media' });
        items = file.result; localStorage.setItem("bfidc_data", JSON.stringify(items)); render(); updatePiece();
    }
}

function handleLogin() { if(uID.value.toLowerCase()==="admin" && uPass.value==="0000") { sessionStorage.setItem("active", "admin"); start(); } else alert("Wrong!"); }
function start() { loginLayer.classList.add("hidden"); appArea.classList.remove("hidden"); who.innerText = "USER: ADMIN"; updatePiece(); render(); }
function logout() { sessionStorage.clear(); location.reload(); }
function toggleInputs() { let isW = type.value==='wood'; thickBox.classList.toggle("hidden", !isW); labelV1.innerText = isW ? "‡¶ö‡¶ì‡ßú‡¶æ" : "‡¶¨‡ßá‡ßú"; render(); }
function updatePiece() { piece.value = items.filter(i => i.tree == tree.value).length + 1; }

function addItem() {
    let t = tree.value, ty = type.value, v1v = parseFloat(v1.value), v2v = parseFloat(v2.value), vev = parseFloat(ve.value) || 0;
    if(!v1v || !v2v) return;
    let cft = ty==='log' ? ((v1v/4)**2 * v2v)/144 : (v1v * vev * v2v)/144;
    let data = {tree: t, piece: editIdx!==null ? items[editIdx].piece : (items.filter(i=>i.tree==t).length+1), type: ty, v1: v1v, v2: v2v, ve: vev, cft: +cft.toFixed(2)};
    if(editIdx!==null) { items[editIdx] = data; editIdx = null; addBtn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® (ENTER)"; } else items.push(data);
    localStorage.setItem("bfidc_data", JSON.stringify(items));
    v1.value=""; v2.value=""; ve.value=""; updatePiece(); render();
    
    // ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶∏‡¶æ‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ '‡¶ó‡¶æ‡¶õ ‡¶®‡¶Ç' ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ
    document.getElementById('tree').focus(); 
}

function deleteItem(idx) { if(confirm("Delete?")) { items.splice(idx, 1); localStorage.setItem("bfidc_data", JSON.stringify(items)); render(); updatePiece(); } }
function startEdit(idx) {
    let i=items[idx]; editIdx=idx; tree.value=i.tree; type.value=i.type; v1.value=i.v1; v2.value=i.v2; ve.value=i.ve;
    addBtn.innerText="‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"; toggleInputs(); window.scrollTo(0,0);
}

function render() {
    let ty = type.value, filtered = items.filter(i => i.type === ty);
    let totalCft = filtered.reduce((s, i) => s + i.cft, 0), totalTrees = new Set(filtered.map(i => i.tree)).size, totalPieces = filtered.length;
    let headerText = ty === 'log' ? `<h3>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶¨‡¶® ‡¶∂‡¶ø‡¶≤‡ßç‡¶™ ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶® ‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶®, ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ó‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶¨‡¶ø‡¶è‡¶´‡¶Ü‡¶á‡¶°‡¶ø‡¶∏‡¶ø, ‡¶è‡¶≤‡¶™‡¶ø‡¶∏‡¶ø</h3><h3>‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶∞‡ßç‡¶§‡¶®‡¶ï‡ßÉ‡¶§ ‡¶∞‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡•§</h3>` : `<h3>‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶æ‡¶†‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>`;
    let html = `<div class="page"><div class="report-header">${headerText}</div><div class="multi-column"><table><tr><th>‡¶ó‡¶æ‡¶õ/‡¶™‡¶ø‡¶∏</th><th>‡¶∏‡¶æ‡¶á‡¶ú</th><th>‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø</th><th class="no-print">‚öô</th></tr>`;
    items.forEach((i, idx) => { if(i.type === ty) {
        let sz = i.type==='log' ? `${i.v1}"x${i.v2}'` : `${i.v1}"x${i.ve}"x${i.v2}'`;
        html += `<tr><td>${i.tree}/${i.piece}</td><td>${sz}</td><td>${i.cft}</td><td class="no-print"><button class="btn-edit" onclick="startEdit(${idx})">E</button><button class="btn-del" onclick="deleteItem(${idx})">D</button></td></tr>`;
    }});
    html += `</table></div><div class="summary-container"><table class="summary-table"><tr><td>‡¶Æ‡ßã‡¶ü ‡¶ó‡¶æ‡¶õ:</td><td>${totalTrees} ‡¶ü‡¶ø</td></tr><tr><td>‡¶Æ‡ßã‡¶ü ‡¶™‡¶ø‡¶∏:</td><td>${totalPieces} ‡¶ü‡¶ø</td></tr><tr><td>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶è‡¶´‡¶ü‡¶ø:</td><td>${totalCft.toFixed(2)}</td></tr></table></div></div>`;
    document.getElementById("printArea").innerHTML = html;
}

if(sessionStorage.getItem("active")) start();
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gsiLoaded()"></script>
</body>
</html>
